<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="ุงูุถู ุฅูู ุงููุฑูุจ ุงูุชุนูููู - SmartEdu">
    
    <title>ุงูุถู ูููุฑูุจ ุงูุชุนูููู - SmartEdu</title>
    <meta name="description" content="ุณุฌู ุจูุงูุงุชู ููุงูุถูุงู ุฅูู ูุฑูุจ Telegram ุงูุชุนููููุฉ">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/join.css">
    <link rel="stylesheet" href="/assets/css/mobile-responsive.css">
</head>
<body data-theme="dark" data-page-type="default">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active">
        <div class="loading-container">
            <div class="spinner"></div>
            <h2 class="loading-title">SmartEdu</h2>
            <p class="loading-text">ุฌุงุฑู ุงูุชุญููู...</p>
        </div>
    </div>

    <!-- Password Screen -->
    <div id="passwordScreen" class="screen">
        <div class="container">
            <div class="welcome-header">
                <div class="logo">๐</div>
                <h1>ุฑุงุจุท ูุญูู</h1>
                <p class="subtitle">ูุฐุง ุงูุฑุงุจุท ูุชุทูุจ ูููุฉ ูุฑูุฑ</p>
            </div>

            <form id="passwordForm">
                <div class="form-group">
                    <label for="passwordInput">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="passwordInput" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ" required>
                </div>

                <button type="submit" class="btn-primary">ุชุญูู โ</button>
            </form>

            <p id="passwordError" style="color: #ff4444; text-align: center; margin-top: 20px; display: none;"></p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen">
        <div class="container">
            <div class="welcome-header">
                <div class="logo">๐</div>
                <h1>SmartEdu</h1>
                <p class="subtitle">ููุตุฉ ุงูุชุนููู ุงูุฐููุฉ</p>
            </div>

            <div class="teacher-info">
                <p class="teacher-name" id="teacherName">...</p>
                <p class="school-name" id="schoolName">...</p>
                <p class="subject-name" id="subjectName">...</p>
            </div>

            <div class="welcome-message">
                <h2>๐ ูุฑุญุจุงู ุจู ุนุฒูุฒู ุงูุทุงูุจ</h2>
                <p id="welcomeText">
                    ุฃููุงู ุจู ูู ููุตุฉ SmartEdu ุงูุชุนููููุฉ<br>
                    ูุณุนุฏูุง ุงูุถูุงูู ุฅูู ุงููุฑูุจ ุงูุชุนูููู ุงูุฎุงุต ุจู ุนูู Telegram
                </p>
            </div>

            <button class="btn-primary" id="startBtn">ุงุจุฏุฃ ุงูุชุณุฌูู โ</button>
        </div>
    </div>

    <!-- Registration Screen -->
    <div id="registrationScreen" class="screen">
        <div class="container">
            <div class="form-header">
                <h2>๐ ุจูุงูุงุชู ุงูุดุฎุตูุฉ</h2>
                <p class="form-description">ุฃุฏุฎู ุจูุงูุงุชู ููุชุณุฌูู</p>
            </div>

            <form id="registrationForm">
                <div class="form-group">
                    <label for="fullName">ุงูุงุณู ุงููุงูู *</label>
                    <input type="text" id="fullName" placeholder="ูุซุงู: ูุญูุฏ ุฃุญูุฏ ุนูู ุญุณู" required minlength="6">
                    <p class="input-hint">๐ก ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุงุณู ุงููุงูู (ุงุณููู ุนูู ุงูุฃูู)</p>
                </div>

                <div class="form-group">
                    <label for="gradeSelect">ุงูุตู *</label>
                    <select id="gradeSelect" required>
                        <option value="">ุงุฎุชุฑ ุงูุตู</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sectionSelect">ุงูุดุนุจุฉ *</label>
                    <select id="sectionSelect" required disabled>
                        <option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="backBtn">โ ุฑุฌูุน</button>
                    <button type="submit" class="btn-primary" id="submitBtn" disabled>ุงูุชุงูู โ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Screen -->
    <div id="successScreen" class="screen">
        <div class="container">
            <div class="success-animation">
                <div class="success-icon">โ</div>
                <h2 class="success-title">ุชู ุงูุชุณุฌูู ุจูุฌุงุญ!</h2>
            </div>

            <div class="student-card">
                <h3>ุดูุฑุงู <span id="studentNameDisplay">...</span></h3>
                <div class="student-details">
                    <p><strong>ุงูุงุณู:</strong> <span id="confirmedName">...</span></p>
                    <p><strong>ุงูุตู:</strong> <span id="confirmedGrade">...</span></p>
                    <p><strong>ุงูุดุนุจุฉ:</strong> <span id="confirmedSection">...</span></p>
                </div>
            </div>

            <div id="telegramSection" class="telegram-section" style="display: none;">
                <h3>๐ฑ ูุฑูุจู ุนูู Telegram</h3>
                <p class="telegram-description">ุงูุถู ุงูุขู ูููุฑูุจ ููุจูุงุก ุนูู ุงุทูุงุน ุจุงููุดุงุฑูุน ูุงูููุงู</p>
                
                <div class="telegram-card">
                    <div class="group-name" id="groupName">...</div>
                    <div class="telegram-actions">
                        <button class="btn-copy" id="copyBtn" onclick="copyLink()">
                            ๐ ูุณุฎ ุงูุฑุงุจุท
                        </button>
                        <a class="btn-open" id="openBtn" href="#" target="_blank">
                            ๐ ูุชุญ ุงูุชุทุจูู
                        </a>
                        <button class="btn-share" id="shareBtn" onclick="shareLink()">
                            ๐ค ูุดุงุฑูุฉ
                        </button>
                    </div>
                </div>
            </div>

            <div id="noTelegramSection" class="no-telegram" style="display: none;">
                <p>ูุง ููุฌุฏ ูุฑูุจ ุชููุฌุฑุงู ููุฐู ุงูุดุนุจุฉ ุญุงููุงู</p>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="/assets/js/config.js"></script>
    <script>
        const API_URL = window.API_BASE || 'http://localhost:8000/api';
        
        // Get token from URL - ุฃููููุฉ ูู query parameter ุซู ุงููุณุงุฑ
        console.log('๐ Full URL:', window.location.href);
        console.log('๐ Pathname:', window.location.pathname);
        console.log('๐ Search:', window.location.search);
        
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        console.log('๐ Token from query params:', token);
        
        // ุฅุฐุง ูู ููุฌุฏ ูู query parameterุ ุฌุฑุจ ุงููุณุงุฑ
        if (!token) {
            const pathParts = window.location.pathname.split('/').filter(p => p);
            console.log('๐ Path parts:', pathParts);
            
            // ุขุฎุฑ ุฌุฒุก ูู ุงููุณุงุฑ (ุฅุฐุง ูู ููู .html)
            const lastPart = pathParts[pathParts.length - 1];
            console.log('๐ Last part:', lastPart);
            
            if (lastPart && !lastPart.includes('.html')) {
                token = lastPart;
                console.log('๐ Token from path:', token);
            }
        }
        
        console.log('๐ Final extracted token:', token);

        // State
        let teacherData = null;
        let selectedGradeId = null;
        let selectedSectionId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                alert('ุฑุงุจุท ุบูุฑ ุตุงูุญ');
                return;
            }
            loadTeacherInfo();
        });

        // Load teacher info
        async function loadTeacherInfo(password = null) {
            try {
                console.log('๐ก Loading teacher info for token:', token);
                const apiUrl = `${API_URL}/sections/join/${token}/info/`;
                console.log('๐ก API URL:', apiUrl);
                
                const options = {
                    method: password ? 'POST' : 'GET',
                    headers: {'Content-Type': 'application/json'}
                };
                
                if (password) {
                    options.body = JSON.stringify({ password });
                }
                
                const response = await fetch(apiUrl, options);
                console.log('๐ก Response status:', response.status);
                
                const data = await response.json();
                console.log('๐ก Response data:', data);
                
                // ๐ ูุญุชุงุฌ ูููุฉ ูุฑูุฑ
                if (data.password_required && !data.success) {
                    showScreen('passwordScreen');
                    if (data.error) {
                        document.getElementById('passwordError').textContent = data.error;
                        document.getElementById('passwordError').style.display = 'block';
                    }
                    return;
                }
                
                if (!data.success) {
                    throw new Error(data.error || 'ูุดู ุชุญููู ุงูุจูุงูุงุช');
                }
                
                teacherData = data;
                
                // Fill teacher info
                document.getElementById('teacherName').textContent = `ุงููุนูู: ${data.teacher.name}`;
                document.getElementById('schoolName').textContent = `๐ซ ${data.teacher.school}`;
                document.getElementById('subjectName').textContent = `๐ ${data.teacher.subject}`;
                document.getElementById('welcomeText').innerHTML = data.welcome_message.replace(/\n/g, '<br>');
                
                // Show welcome screen
                showScreen('welcomeScreen');
                
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช');
            }
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Password form submit
        document.getElementById('passwordForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            document.getElementById('passwordError').style.display = 'none';
            await loadTeacherInfo(password);
        });

          // Buttons
        document.getElementById('startBtn')?.addEventListener('click', () => {
            // Load grades
            const gradeSelect = document.getElementById('gradeSelect');
            gradeSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตู</option>';
            
            teacherData.grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = grade.name;
                option.dataset.sections = JSON.stringify(grade.sections);
                gradeSelect.appendChild(option);
            });
            
            showScreen('registrationScreen');
        });

        document.getElementById('backBtn')?.addEventListener('click', () => {
            showScreen('welcomeScreen');
        });

        // Grade change
        document.getElementById('gradeSelect')?.addEventListener('change', (e) => {
            const sectionSelect = document.getElementById('sectionSelect');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!e.target.value) {
                sectionSelect.disabled = true;
                sectionSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>';
                submitBtn.disabled = true;
                return;
            }
            
            selectedGradeId = e.target.value;
            const sections = JSON.parse(e.target.selectedOptions[0].dataset.sections);
            
            sectionSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.name;
                sectionSelect.appendChild(option);
            });
            
            sectionSelect.disabled = false;
        });

        // Section change
        document.getElementById('sectionSelect')?.addEventListener('change', (e) => {
            const submitBtn = document.getElementById('submitBtn');
            selectedSectionId = e.target.value;
            submitBtn.disabled = !selectedSectionId;
        });

        // Form submit
        document.getElementById('registrationForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            // โ Validation - ุชุญูู ูู ุงูุงุณู ุงูุฑุจุงุนู
            if (fullName.length < 6) {
                alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุงุณู ุงููุงูู');
                return;
            }
            
            const nameParts = fullName.split(' ').filter(p => p.length > 0);
            if (nameParts.length < 4) {
                alert(`ุงูุงุณู ูุฌุจ ุฃู ูููู ุฑุจุงุนูุงู (${nameParts.length}/4)\nูุซุงู: ูุญูุฏ ุฃุญูุฏ ุนูู ุญุณู`);
                return;
            }
            
            // โ ุชุญูู ูู ุงูุญุฑูู ุงูุนุฑุจูุฉ ููุท
            const arabicPattern = /^[\u0600-\u06FF\s]+$/;
            if (!arabicPattern.test(fullName)) {
                alert('ุงูุงุณู ูุฌุจ ุฃู ูุญุชูู ุนูู ุญุฑูู ุนุฑุจูุฉ ููุท');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ุฌุงุฑู ุงูุชุญูู...';
            
            // โ Step 1: ุงูุชุญูู ูู ุงูุทุงูุจ ุฃููุงู
            const verifyData = {
                student_name: fullName,
                section_id: parseInt(selectedSectionId)
            };
            console.log('๐ ุงูุชุญูู ูู ุงูุทุงูุจ:', verifyData);
            
            try {
                const response = await fetch(`${API_URL}/sections/verify-student-join/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(verifyData)
                });
                
                const data = await response.json();
                console.log('๐ก Verify response:', response.status, data);
                
                if (!data.success) {
                    // โ ุงูุทุงูุจ ุบูุฑ ููุฌูุฏ
                    console.error('โ Student not found:', data);
                    
                    let errorMessage = data.message || 'ุงูุงุณู ุบูุฑ ููุฌูุฏ ูู ูุฐู ุงูุดุนุจุฉ';
                    
                    // ุนุฑุถ ุงูุงูุชุฑุงุญุงุช ุฅู ููุฌุฏุช
                    if (data.suggestions && data.suggestions.length > 0) {
                        errorMessage += '\n\n๐ ูู ุชูุตุฏ ุฃุญุฏ ูุฐู ุงูุฃุณูุงุกุ\n';
                        data.suggestions.forEach(s => {
                            errorMessage += `\nโข ${s.name} (${s.similarity}% ุชุดุงุจู)`;
                        });
                    }
                    
                    errorMessage += '\n\n๐ก ' + (data.action || 'ุชูุงุตู ูุน ูุนููู ูุฅุถุงูุฉ ุงุณูู');
                    
                    alert(errorMessage);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ุงูุชุงูู โ';
                    return;
                }
                
                // โ ูุฌุญ ุงูุชุญูู - ุนุฑุถ ูุนูููุงุช ุงูุทุงูุจ ูุฑุงุจุท ุงููุฑูุจ
                console.log('โ Student verified:', data.student);
                showSuccessScreen(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'ุญุฏุซ ุฎุทุฃ ูู ุงูุชุณุฌูู');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ุงูุชุงูู โ';
            }
        });

        // Show success screen
        function showSuccessScreen(data) {
            const student = data.student;
            
            document.getElementById('studentNameDisplay').textContent = student.name;
            document.getElementById('confirmedName').textContent = student.name;
            document.getElementById('confirmedGrade').textContent = student.grade;
            document.getElementById('confirmedSection').textContent = student.section;
            
            // Telegram section
            if (data.telegram_group && data.telegram_group.invite_link) {
                const groupName = data.telegram_group.name;
                const inviteLink = data.telegram_group.invite_link;
                
                document.getElementById('groupName').textContent = groupName;
                document.getElementById('openBtn').href = inviteLink;
                
                // Store for copy/share
                window.telegramLink = inviteLink;
                window.groupName = groupName;
                
                document.getElementById('telegramSection').style.display = 'block';
                document.getElementById('noTelegramSection').style.display = 'none';
            } else {
                document.getElementById('telegramSection').style.display = 'none';
                document.getElementById('noTelegramSection').style.display = 'block';
            }
            
            showScreen('successScreen');
            confetti();
        }

        // Copy link
        function copyLink() {
            if (!window.telegramLink) return;
            
            navigator.clipboard.writeText(window.telegramLink).then(() => {
                alert('โ ุชู ูุณุฎ ุงูุฑุงุจุท');
            }).catch(() => {
                alert('โ ูุดู ุงููุณุฎ');
            });
        }

        // Share link
        async function shareLink() {
            if (!window.telegramLink) return;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: window.groupName || 'ูุฑูุจ ุงูุชููุฌุฑุงู',
                        text: 'ุงูุถู ุฅูู ุงููุฑูุจ ุงูุชุนูููู',
                        url: window.telegramLink
                    });
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                copyLink();
            }
        }

        // Confetti animation
        function confetti() {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
            const count = 50;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.style.position = 'fixed';
                    el.style.width = '10px';
                    el.style.height = '10px';
                    el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    el.style.left = Math.random() * 100 + '%';
                    el.style.top = '-20px';
                    el.style.borderRadius = '50%';
                    el.style.pointerEvents = 'none';
                    el.style.zIndex = '9999';
                    el.style.animation = 'fall 3s linear';
                    document.body.appendChild(el);
                    
                    setTimeout(() => el.remove(), 3000);
                }, i * 30);
            }
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
            .screen { display: none; }
            .screen.active { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        `;
        document.head.appendChild(style);
    </script>

    <!-- โ Dark Mode System -->
    <script src="/assets/js/dark-mode-manager.js"></script>
    <script src="/assets/js/dark-mode-init.js"></script>
</body>
</html>    