<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00ADEF">
    
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø´Ø±ÙˆØ¹ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <meta name="description" content="Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ ÙˆØµÙÙˆÙÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠØ©">
    <meta name="robots" content="noindex, nofollow">
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/dark-mode.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/mobile-responsive.css">
    
    <style>
        .user-menu-item {
            display: block;
            padding: 10px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .user-menu-item:hover {
            background: var(--bg-color);
        }
        .user-menu-logout {
            color: var(--danger-color);
        }
    </style>
</head>
<body data-page-type="dashboard">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ“</div>
                <div class="logo-text">
                    <h1>Ù…Ø´Ø±ÙˆØ¹ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
                    <p>SmartEduProject</p>
                </div>
            </div>
            
            <div class="header-actions">
                <!-- Hamburger Menu Button (Mobile Only) -->
                <button class="hamburger-btn mobile-only" onclick="toggleMobileMenu()" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Ø§Ù„Ù…Ø¹Ù„Ù…</span>
                    <span>â–¼</span>
                </div>
            </div>
        </div>
    </header>

    <!-- User Menu Dropdown -->
    <div id="userMenuDropdown" style="display: none; position: fixed; top: 70px; left: 20px; background: var(--card-bg); border-radius: 10px; box-shadow: 0 4px 12px var(--shadow-color); padding: 10px; z-index: 1000; min-width: 200px;">
        <a href="/pages/settings.html" class="user-menu-item">
            âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </a>
        <a href="#" onclick="auth.logout(); return false;" class="user-menu-item user-menu-logout">
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </a>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Navigation Sidebar -->
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-header">
            <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
            <button class="mobile-nav-close" onclick="toggleMobileMenu()" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
        </div>
        <ul class="mobile-nav-list">
            <li><a href="/pages/dashboard.html" class="active">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
            <li><a href="/pages/create-project.html">ğŸ“š Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹</a></li>
            <li><a href="/pages/sections-manage.html">ğŸ« Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´ÙØ¹Ø¨</a></li>
            <li><a href="/pages/sections-dashboard.html">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a></li>
            <li><a href="/pages/settings.html">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            <li><a href="#" onclick="auth.logout(); return false;" class="logout-link">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Navigation -->
        <nav class="nav fade-in desktop-only">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/pages/dashboard.html" class="nav-link active">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('projects'); return false;">
                        <span class="nav-icon">ğŸ“š</span>
                        <span>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/pages/sections-manage.html" class="nav-link">
                        <span class="nav-icon">ğŸ«</span>
                        <span>Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´ÙØ¹Ø¨</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/pages/sections-dashboard.html" class="nav-link">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('submissions'); return false;">
                        <span class="nav-icon">ğŸ“¤</span>
                        <span>Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/pages/settings.html" class="nav-link">
                        <span class="nav-icon">âš™ï¸</span>
                        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Welcome Section -->
        <div class="card slide-up">
            <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="teacherName">Ø§Ù„Ù…Ø¹Ù„Ù…</span></h2>
            <p class="text-muted">Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ù‹Ø§ Ù…Ø«Ù…Ø±Ù‹Ø§ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card stagger-item">
                <div class="stat-icon">ğŸ“š</div>
                <div class="stat-value" id="projectsCount">0</div>
                <div class="stat-label">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
            </div>
            
            <div class="stat-card success stagger-item">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="studentsCount">0</div>
                <div class="stat-label">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            </div>
            
            <div class="stat-card warning stagger-item">
                <div class="stat-icon">ğŸ“¤</div>
                <div class="stat-value" id="submissionsCount">0</div>
                <div class="stat-label">Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</div>
            </div>
            
            <div class="stat-card danger stagger-item">
                <div class="stat-icon">â³</div>
                <div class="stat-value" id="pendingCount">0</div>
                <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            </div>
        </div>

        <!-- Sections Stats Grid -->
        <div class="stats-grid" style="margin-top: 30px;">
            <div class="stat-card primary stagger-item" onclick="location.href='/pages/sections-manage.html'" style="cursor: pointer;">
                <div class="stat-icon">ğŸ«</div>
                <div class="stat-value" id="sectionsGradesCount">0</div>
                <div class="stat-label">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
            </div>
            
            <div class="stat-card info stagger-item" onclick="location.href='/pages/sections-manage.html'" style="cursor: pointer;">
                <div class="stat-icon">ğŸ“˜</div>
                <div class="stat-value" id="sectionsSectionsCount">0</div>
                <div class="stat-label">Ø§Ù„Ø´ÙØ¹Ø¨</div>
            </div>
            
            <div class="stat-card success stagger-item" onclick="location.href='/pages/sections-dashboard.html'" style="cursor: pointer;">
                <div class="stat-icon">ğŸ‘¨â€ğŸ“</div>
                <div class="stat-value" id="sectionsStudentsCount">0</div>
                <div class="stat-label">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</div>
            </div>
            
            <div class="stat-card warning stagger-item" onclick="location.href='/pages/sections-dashboard.html'" style="cursor: pointer;">
                <div class="stat-icon">âœ…</div>
                <div class="stat-value" id="sectionsJoinedCount">0</div>
                <div class="stat-label">Ø§Ù†Ø¶Ù…ÙˆØ§ Ù„Ù„Ù‚Ø±ÙˆØ¨Ø§Øª</div>
            </div>
        </div>

        <!-- Recent Projects -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“š Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</h3>
            </div>
            <div class="card-body" id="recentProjects">
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-primary btn-block" onclick="createProject()">
                            â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-success btn-block" onclick="viewSubmissions()">
                            ğŸ“¥ Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… Config ÙŠÙØ­Ù…Ù‘Ù„ Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="/assets/js/config.js"></script>
    
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/app.js"></script>
    <script src="/assets/js/sections-api.js"></script>
    <script src="/js/telegram-preview-modal.js"></script>
    
    <script>
        // âœ… API_BASE ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ ÙÙŠ config.js
        
        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
        auth.protectPage();
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const teacher = auth.getTeacher();
        if (teacher) {
            document.getElementById('userName').textContent = auth.getFirstName();
            document.getElementById('userAvatar').textContent = auth.getInitials();
            document.getElementById('teacherName').textContent = auth.getFirstName();
        }
        
        // Toggle User Menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenuDropdown');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenuDropdown');
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu.contains(e.target) && !menu.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        // Load Dashboard Data
        async function loadDashboard() {
            try {
                // Load projects
                const projectsData = await api.getProjects();
                const projects = projectsData.projects || [];
                
                // Update stats
                document.getElementById('projectsCount').textContent = projects.length;
                
                // Calculate total students and submissions
                let totalStudents = 0;
                let totalSubmissions = 0;
                let pendingSubmissions = 0;
                
                for (const project of projects) {
                    // These would need actual API calls in production
                    totalSubmissions += project.submissions_count || 0;
                }
                
                document.getElementById('studentsCount').textContent = totalStudents;
                document.getElementById('submissionsCount').textContent = totalSubmissions;
                document.getElementById('pendingCount').textContent = pendingSubmissions;
                
                // Load sections stats
                await loadSectionsStats();
                
                // Display recent projects
                displayRecentProjects(projects.slice(0, 5));
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                UI.showError('#recentProjects', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // Load sections statistics
        async function loadSectionsStats() {
            try {
                const response = await sectionsAPI.getMyGrades();
                const stats = response.stats || {};
                
                // Update sections stats
                document.getElementById('sectionsGradesCount').textContent = stats.total_grades || 0;
                document.getElementById('sectionsSectionsCount').textContent = stats.total_sections || 0;
                document.getElementById('sectionsStudentsCount').textContent = stats.total_students || 0;
                
                // Calculate joined count (Ø³Ù†Ø­Ø³Ø¨Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
                let totalJoined = 0;
                if (response.grades && response.grades.length > 0) {
                    for (const grade of response.grades) {
                        // Get sections for this grade
                        try {
                            const sectionsData = await sectionsAPI.getGradeSections(grade.id);
                            if (sectionsData.sections) {
                                for (const section of sectionsData.sections) {
                                    totalJoined += section.joined_count || 0;
                                }
                            }
                        } catch (err) {
                            console.error('Error loading grade sections:', err);
                        }
                    }
                }
                
                document.getElementById('sectionsJoinedCount').textContent = totalJoined;
                
            } catch (error) {
                console.error('Error loading sections stats:', error);
                // Don't show error, just keep default values
                document.getElementById('sectionsGradesCount').textContent = '0';
                document.getElementById('sectionsSectionsCount').textContent = '0';
                document.getElementById('sectionsStudentsCount').textContent = '0';
                document.getElementById('sectionsJoinedCount').textContent = '0';
            }
        }
        
        function displayRecentProjects(projects) {
            const container = document.getElementById('recentProjects');
            
            if (projects.length === 0) {
                UI.showEmpty(container, 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯', 'ğŸ“­');
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><thead><tr>';
            html += '<th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</th></tr></thead><tbody>';
            
            projects.forEach(project => {
                const deadline = new Date(project.deadline);
                const now = new Date();
                const isExpired = deadline < now;
                
                html += `
                    <tr>
                        <td><strong>${project.title}</strong></td>
                        <td>${project.subject}</td>
                        <td>${project.grade_display || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${UI.formatDate(project.deadline)}</td>
                        <td>
                            <span class="badge ${project.is_active ? 'badge-success' : 'badge-secondary'}">
                                ${project.is_active ? 'âœ… Ù†Ø´Ø·' : 'âŒ ØºÙŠØ± Ù†Ø´Ø·'}
                            </span>
                            ${isExpired ? '<span class="badge badge-danger">â° Ø§Ù†ØªÙ‡Ù‰</span>' : ''}
                        </td>
                        <td>
                            ${project.telegram_sent ? 
                                `
                                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                  <span class="badge badge-success" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 6px 12px;">âœ“ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                                  <button onclick="resendTelegram(${project.id}, '${project.title.replace(/'/g, "\\'")}')" class="btn btn-sm btn-warning" style="padding: 6px 12px; font-size: 13px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 6px; cursor: pointer;">
                                    â†» Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                                  </button>
                                </div>
                                ` : 
                                `<button onclick="sendTelegramNow(${project.id}, '${project.title.replace(/'/g, "\\'")}');" class="btn btn-sm btn-primary" style="padding: 6px 16px; font-size: 13px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: none; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\`translateY(-2px)\`" onmouseout="this.style.transform=\`translateY(0)\`"><span>ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</span></button>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function createProject() {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            window.location.href = 'create-project.html';
        }
        
        function viewSubmissions() {
            UI.showModal(
                'Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª',
                '<p>Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</p>',
                [{ text: 'Ø­Ø³Ù†Ø§Ù‹', class: 'btn-primary', onclick: 'UI.closeModal()' }]
            );
        }
        
        function showSection(section) {
            UI.showToast(`Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ${section === 'projects' ? 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹' : 'Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª'} Ù‚Ø±ÙŠØ¨Ø§Ù‹`, 'info');
        }
        
        // âœ… Send Telegram Now - Open Progress Page in Browser
        function sendTelegramNow(projectId, projectTitle) {
            // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ ØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
            const url = `telegram-send-direct.html?project_id=${projectId}`;
            window.open(url, '_blank');
        }
        
        // ğŸ” Resend Telegram - Open Direct Send Page
        function resendTelegram(projectId, projectTitle) {
            const url = `telegram-send-direct.html?project_id=${projectId}`;
            window.open(url, '_blank');
        }
        
        // âœ… Telegram functions are now in telegram-preview-modal.js
        
        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            const overlay = document.getElementById('mobileNavOverlay');
            const isOpen = mobileNav.classList.contains('open');
            
            if (isOpen) {
                mobileNav.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                mobileNav.classList.add('open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            App.updateUserUI();
            loadDashboard();
        });
    </script>

    <!-- âœ… Dark Mode System -->
    <script src="/assets/js/dark-mode-manager.js"></script>
    <script src="/assets/js/dark-mode-init.js"></script>
</body>
</html>
