<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00ADEF">
    
    <title>ุฅุนุฏุงุฏ ุงูุตููู ูุงูุดูุนุจ - ูุดุฑูุนู ุงูุฐูู</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/dark-mode.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/mobile-responsive.css">
    
    <style>
        /* Telegram Session Status */
        .telegram-session-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            border-radius: 12px;
            border: 2px solid;
            transition: all 0.3s ease;
        }
        
        .telegram-session-status.connected {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .telegram-session-status.disconnected {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .telegram-session-status .status-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .telegram-session-status .status-icon {
            font-size: 2.5rem;
            line-height: 1;
        }
        
        .telegram-session-status .status-text h4 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: #333;
        }
        
        .telegram-session-status .status-text p {
            margin: 0;
            color: #666;
            font-size: 0.95rem;
        }
        
        .telegram-session-status .status-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .modal-dialog {
            width: 100%;
            max-width: 600px;
            margin: 20px;
        }
        
        .modal-dialog .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 1.4rem;
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Spinner */
        .spinner-border {
            display: inline-block;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: currentColor;
            border-radius: 50%;
            animation: spinner-border 1s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        /* Result Items */
        .result-item {
            padding: 12px 15px;
            background: #f8f9fa;
            border-left: 4px solid;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .result-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .result-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .result-item .result-text {
            flex: 1;
            color: #333;
            font-weight: 500;
        }
        
        .result-item .result-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .result-item .result-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body data-page-type="wizard">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h2>๐ ุฅุนุฏุงุฏ ุงูุตููู ูุงูุดูุนุจ</h2>
            </div>
            <div class="navbar-menu">
                <a href="/pages/dashboard.html" class="btn btn-secondary">ุงูุนูุฏุฉ ูููุญุฉ ุงูุชุญูู</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="sections-container">
        <!-- Header -->
        <div class="sections-header fade-in">
            <h1>๐ฏ ุฅุนุฏุงุฏ ุงูุตููู ูุงูุดูุนุจ</h1>
            <p>ูู ุจุฅุนุฏุงุฏ ุตูููู ุงูุฏุฑุงุณูุฉ ูุฅูุดุงุก ุฑูุงุจุท ุฐููุฉ ููู ุดุนุจุฉ ูุงุณุชูุจุงู ุงูุทูุงุจ</p>
        </div>

        <!-- Setup Steps -->
        <div class="setup-steps fade-in">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-title">ุงุฎุชูุงุฑ ุงููุฑุญูุฉ</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-title">ุงุฎุชูุงุฑ ุงูุตู</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-title">ุนุฏุฏ ูููุน ุงูุดูุนุจ</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-title">ุงุฎุชูุงุฑ ุงูุดูุนุจ</div>
            </div>
            <div class="step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-title">ุฅูุดุงุก ุงููุฑูุจุงุช</div>
            </div>
            <div class="step" data-step="6">
                <div class="step-number">6</div>
                <div class="step-title">ุงููุฑุงุฌุนุฉ ูุงูุญูุธ</div>
            </div>
        </div>

        <!-- Step 1: ุงุฎุชูุงุฑ ุงููุฑุญูุฉ -->
        <div class="setup-form slide-in" id="step1" style="display: block;">
            <div class="form-section">
                <h3>๐ซ ุงุฎุชุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ</h3>
                
                <div class="level-selector">
                    <label class="level-option">
                        <input type="radio" name="level" value="elementary">
                        <div class="level-card">
                            <span class="level-icon">๐</span>
                            <div class="level-name">ุงุจุชุฏุงุฆู</div>
                            <div class="level-grades">ุงูุตููู 1-6</div>
                        </div>
                    </label>

                    <label class="level-option">
                        <input type="radio" name="level" value="middle">
                        <div class="level-card">
                            <span class="level-icon">๐</span>
                            <div class="level-name">ูุชูุณุท</div>
                            <div class="level-grades">ุงูุตููู 1-3</div>
                        </div>
                    </label>

                    <label class="level-option">
                        <input type="radio" name="level" value="high">
                        <div class="level-card">
                            <span class="level-icon">๐</span>
                            <div class="level-name">ุซุงููู</div>
                            <div class="level-grades">ุงูุตููู 1-3</div>
                        </div>
                    </label>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label class="form-label">ุงุณู ุงููุฏุฑุณุฉ *</label>
                    <input type="text" id="schoolName" class="form-control" 
                           placeholder="ูุซุงู: ูุฏุฑุณุฉ ุงูุฎูุฑุฉ ุงููุชูุณุทุฉ ุงูุฃููู" required>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" id="nextStep1">
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 2: ุงุฎุชูุงุฑ ุงูุตู -->
        <div class="setup-form slide-in" id="step2" style="display: none;">
            <div class="form-section">
                <h3>๐ ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู</h3>
                
                <div class="grade-selector" id="gradeSelector">
                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep2">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="nextStep2">
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 3: ุฅุฏุฎุงู ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ -->
        <div class="setup-form slide-in" id="step3" style="display: none;">
            <div class="form-section">
                <h3>๐ ูุง ูู ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉุ</h3>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    ุฃุฏุฎู ุงุณู ุงููุงุฏุฉ ุงูุชู ุชุฏุฑุณูุง ููุฐุง ุงูุตู
                </p>

                <div class="form-group">
                    <label for="subjectName">
                        <span class="icon">๐</span>
                        ุงุณู ุงููุงุฏุฉ
                    </label>
                    <input 
                        type="text" 
                        id="subjectName" 
                        class="form-control" 
                        placeholder="ูุซุงู: ุงูููุงุฑุงุช ุงูุฑูููุฉุ ุงูุฑูุงุถูุงุชุ ุงูุนููู..."
                        required
                    >
                    <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                        ๐ก ุณุชูุณุชุฎุฏู ูู ุชุณููุฉ ุงููุฑูุจุงุช ูุงููุดุงุฑูุน
                    </small>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep3">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="nextStep3">
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 4: ุนุฏุฏ ุงูุดูุนุจ ูููุน ุงูุชุฑููู -->
        <div class="setup-form slide-in" id="step4" style="display: none;">
            <div class="form-section">
                <h3>๐ข ุญุฏุฏ ุนุฏุฏ ุงูุดูุนุจ ูููุน ุงูุชุฑููู</h3>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    ูู ุนุฏุฏ ุงูุดูุนุจ ูููู ุชุฑูุฏ ุชุฑููููุงุ
                </p>

                <!-- ุนุฏุฏ ุงูุดูุนุจ -->
                <div style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">๐ ุนุฏุฏ ุงูุดูุนุจ:</h4>
                    <div class="sections-count-input">
                        <button type="button" class="count-btn" id="decreaseCount">-</button>
                        <div class="count-display" id="sectionsCount">5</div>
                        <button type="button" class="count-btn" id="increaseCount">+</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                        <small>ุงูุญุฏ ุงูุฃุฏูู: 1 | ุงูุญุฏ ุงูุฃูุตู: 20</small>
                    </div>
                </div>

                <!-- ููุน ุงูุชุฑููู -->
                <div style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">๐ท๏ธ ููุน ุงูุชุฑููู:</h4>
                    <div style="display: grid; gap: 15px; max-width: 500px; margin: 0 auto;">
                        <label style="display: flex; align-items: center; padding: 20px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="sectionType" value="arabic" checked
                                   style="width: 24px; height: 24px; margin-left: 15px; cursor: pointer;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">ุญุฑูู ุนุฑุจูุฉ</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">ุฃุ ุจุ ุฌุ ุฏุ ู...</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; padding: 20px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="sectionType" value="numbers"
                                   style="width: 24px; height: 24px; margin-left: 15px; cursor: pointer;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">ุฃุฑูุงู</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">1ุ 2ุ 3ุ 4ุ 5...</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep4">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="nextStep4">
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 5: ุงุฎุชูุงุฑ ุงูุดูุนุจ ุงููุญุฏุฏุฉ -->
        <div class="setup-form slide-in" id="step5" style="display: none;">
            <div class="form-section">
                <h3>โ ุงุฎุชุฑ ุงูุดูุนุจ ุงููุทููุจุฉ</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ุงุฎุชุฑ ุดุนุจุฉ ูุงุญุฏุฉ ุฃู ุฃูุซุฑ ุฃู ุฌููุน ุงูุดูุนุจ
                </p>

                <!-- ุฒุฑ ุชุญุฏูุฏ ุงููู / ุฅูุบุงุก ุงููู -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <button type="button" class="btn btn-secondary" id="selectAllSections" style="margin: 0 5px;">
                        โ๏ธ ุชุญุฏูุฏ ุงููู
                    </button>
                    <button type="button" class="btn btn-secondary" id="deselectAllSections" style="margin: 0 5px;">
                        โ ุฅูุบุงุก ุงููู
                    </button>
                </div>
                
                <!-- ูุงุฆูุฉ ุงูุดูุนุจ -->
                <div id="sectionsCheckboxList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-width: 800px; margin: 0 auto;">
                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                </div>

                <div style="text-align: center; margin-top: 25px; padding: 15px; background: var(--info-bg); border-radius: 10px;">
                    <p style="margin: 0; color: var(--text-secondary);">
                        <strong id="selectedSectionsCount">0</strong> ุดูุนุจุฉ ูุฎุชุงุฑุฉ
                    </p>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep5">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="nextStep5" disabled>
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 6: ุฅูุดุงุก ูุฑูุจุงุช Telegram -->
        <div class="setup-form slide-in" id="step6" style="display: none;">
            <div class="form-section">
                <h3>๐ฑ ุฅูุดุงุก ูุฑูุจุงุช Telegram</h3>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">
                    ุฑุจุท ุญุณุงุจู ูุฅูุดุงุก ูุฑูุจ ุชููุงุฆู ููู ุดุนุจุฉ
                </p>

                <!-- Session Status Card -->
                <div id="telegramSessionStatus" class="telegram-session-status disconnected" style="margin: 25px 0;">
                    <div class="status-info">
                        <div class="status-icon">โ๏ธ</div>
                        <div class="status-text">
                            <h4 style="margin: 0 0 5px 0;">ุญุงูุฉ ุงูุงุชุตุงู</h4>
                            <p id="sessionStatusMessage" style="margin: 0; color: #666;">ุฌุงุฑู ุงูุชุญูู...</p>
                        </div>
                    </div>
                    <div class="status-actions">
                        <button type="button" class="btn btn-primary" id="linkAccountBtn" onclick="showLinkAccountModal()">
                            ุฑุจุท ุญุณุงุจ Telegram
                        </button>
                        <button type="button" class="btn btn-danger" id="disconnectBtn" style="display: none;" onclick="disconnectTelegram()">
                            ูุตู ุงูุฑุจุท
                        </button>
                    </div>
                </div>

                <!-- Groups Creation Section -->
                <div id="createGroupsSection" style="opacity: 0.5; pointer-events: none; transition: all 0.3s;">
                    <!-- ููุฎุต -->
                    <div class="creation-summary" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">๐ ููุฎุต ุงูุฅูุดุงุก:</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>ุงูุตู:</strong>
                                <span id="summaryGrade">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <strong>ุงููุงุฏุฉ:</strong>
                                <span id="summarySubject">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <strong>ุนุฏุฏ ุงููุฑูุจุงุช:</strong>
                                <span id="summaryCount">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <strong>ุงูุดูุนุจ:</strong>
                                <span id="summarySections">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ุฒุฑ ุงูุฅูุดุงุก -->
                    <div style="text-align: center; margin: 30px 0;">
                        <button type="button" class="btn btn-success" id="createGroupsBtn" 
                                style="padding: 18px 50px; font-size: 1.2rem; background: #28a745; border: none; border-radius: 12px;">
                            <span id="createGroupsText">๐ ุฅูุดุงุก ุงููุฑูุจุงุช ุงูุขู</span>
                            <span id="createGroupsSpinner" style="display: none;">
                                <span class="spinner-border spinner-border-sm"></span> ุฌุงุฑู ุงูุฅูุดุงุก...
                            </span>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div id="creationProgress" style="display: none; margin: 20px 0;">
                        <div class="progress-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span class="progress-title" style="font-weight: 600;">ุฌุงุฑู ุงูุฅูุดุงุก...</span>
                            <span class="progress-count" id="progressCount">0/0</span>
                        </div>
                        <div style="background: #f0f0f0; height: 30px; border-radius: 5px; overflow: hidden;">
                            <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="creationResults" style="display: none; margin-top: 20px;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">โ ูุชุงุฆุฌ ุงูุฅูุดุงุก:</h4>
                        <div id="resultsList" style="display: grid; gap: 10px;">
                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep6">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="nextStep6" disabled>
                    ุงูุชุงูู โ
                </button>
            </div>
        </div>

        <!-- Step 7: ุงููุฑุงุฌุนุฉ ูุงูุญูุธ -->
        <div class="setup-form slide-in" id="step7" style="display: none;">
            <div class="form-section">
                <h3>โ ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช</h3>
                
                <div class="summary-grid" id="summaryGrid">
                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                </div>

                <!-- Sections Preview Table -->
                <div id="sectionsPreviewContainer" style="margin-top: 30px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; text-align: center;">
                        ๐ ูุนุงููุฉ ุงูุดูุนุจ ูุฑูุงุจุท ุงูุชูููุฌุฑุงู
                    </h4>
                    <div style="overflow-x: auto; border-radius: 12px; border: 2px solid var(--border-color);">
                        <table id="sectionsPreviewTable" style="width: 100%; border-collapse: collapse; background: var(--card-bg);">
                            <thead>
                                <tr style="background: var(--primary-color); color: white;">
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">#</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">ุงูุตู</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">ุงูุดุนุจุฉ</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">ุฑุงุจุท ุงูุชูููุฌุฑุงู</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="sectionsPreviewTableBody">
                                <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; padding: 12px; background: rgba(0, 173, 239, 0.05); border-radius: 8px; text-align: center; color: var(--text-secondary); font-size: 14px;">
                        ๐ก ุชุฃูุฏ ูู ุตุญุฉ ุฌููุน ุงูุฑูุงุจุท ูุจู ุงูุญูุธ
                    </p>
                </div>

                <!-- Sections list after save -->
                <div id="sectionsResultsList" style="display: none; margin-top: 30px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">
                        โ ุชู ุฅูุดุงุก ุงูุดูุนุจ ุจูุฌุงุญ
                    </h3>
                    <div id="sectionsCards">
                        <!-- ุณูุชู ููุคูุง ุจุนุฏ ุงูุญูุธ -->
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevStep7">
                    โ ุงูุณุงุจู
                </button>
                <button type="button" class="btn btn-primary" id="saveSetup">
                    ๐พ ุญูุธ ุงูุตู ูุงูุดูุนุจ
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
            <p>ุฌุงุฑู ุงูุญูุธ...</p>
        </div>
    </div>

    <!-- Link Telegram Account Modal -->
    <div id="linkAccountModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-content">
                <!-- Header -->
                <div class="modal-header" style="border-bottom: 1px solid #dee2e6; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">๐ฑ ุฑุจุท ุญุณุงุจ Telegram</h3>
                    <button type="button" onclick="closeLinkAccountModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                </div>

                <!-- Body -->
                <div class="modal-body" style="padding: 30px;">
                    <!-- Step 1: ุฅุฏุฎุงู ุงูุฑูู -->
                    <div id="linkStep1" style="display: block;">
                        <p style="color: #666; margin-bottom: 20px; text-align: center;">
                            ุฃุฏุฎู ุฑูู ูุงุชูู ุงููุณุฌู ูู Telegram
                        </p>
                        
                        <div class="form-group">
                            <input type="tel" id="linkPhoneNumber" class="form-control" 
                                   placeholder="+966544711074" 
                                   style="padding: 15px; font-size: 1.1rem; text-align: center; border: 2px solid #667eea; border-radius: 10px;">
                            <small style="color: #666; display: block; margin-top: 8px; text-align: center;">
                                ูุฌุจ ุฃู ูุจุฏุฃ ุจู + ูุชุจูุนุงู ุจููุฏ ุงูุฏููุฉ
                            </small>
                        </div>

                        <button type="button" onclick="sendVerificationCode()" class="btn btn-primary" 
                                style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;">
                            ๐ค ุฅุฑุณุงู ููุฏ ุงูุชุญูู
                        </button>
                    </div>

                    <!-- Step 2: ุฅุฏุฎุงู ุงูููุฏ -->
                    <div id="linkStep2" style="display: none;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">๐ฌ</div>
                            <p style="color: #666; margin-bottom: 10px;">
                                ุชู ุฅุฑุณุงู ููุฏ ุงูุชุญูู ุฅูู:
                            </p>
                            <p id="linkPhoneDisplay" style="font-size: 1.2rem; font-weight: 600; color: #333;">
                                +966***
                            </p>
                        </div>

                        <div class="form-group">
                            <input type="text" id="linkVerificationCode" class="form-control" 
                                   placeholder="12345" maxlength="5"
                                   style="padding: 15px; font-size: 2rem; text-align: center; letter-spacing: 10px; border: 2px solid #667eea; border-radius: 10px; font-weight: 600;">
                        </div>

                        <div id="linkTimer" style="text-align: center; margin: 15px 0; font-size: 1.1rem; font-weight: 600; color: #667eea;">
                            โฑ๏ธ <span id="linkTimerValue">01:00</span>
                        </div>

                        <div id="deliveryInfo" style="text-align: center; margin: 8px 0; color: #555; font-weight: 600;">
                            ุทุฑููุฉ ุงูุฅุฑุณุงู: -
                        </div>

                        <button type="button" onclick="verifyCode()" class="btn btn-primary" 
                                style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;">
                            โ ุชุญูู ูู ุงูููุฏ
                        </button>

                        <button type="button" id="linkResendBtn" onclick="resendVerificationCode()"
                                class="btn btn-secondary"
                                style="width: 100%; margin-top: 10px; padding: 12px; font-size: 1rem;" disabled>
                            ๐ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูููุฏ
                        </button>
                    </div>

                    <!-- Step 3: ูููุฉ ูุฑูุฑ 2FA -->
                    <div id="linkStep3" style="display: none;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">๐</div>
                            <h4 style="color: #333; margin-bottom: 10px;">ุงูุชุญูู ุจุฎุทูุชูู</h4>
                            <p style="color: #666;">
                                ุญุณุงุจู ูุญูู ุจูููุฉ ูุฑูุฑ. ูุฑุฌู ุฅุฏุฎุงููุง ูููุชุงุจุนุฉ.
                            </p>
                        </div>

                        <div class="form-group">
                            <input type="password" id="link2FAPassword" class="form-control" 
                                   placeholder="ูููุฉ ุงููุฑูุฑ"
                                   style="padding: 15px; font-size: 1.1rem; text-align: center; border: 2px solid #667eea; border-radius: 10px;">
                        </div>

                        <button type="button" onclick="verify2FAPassword()" class="btn btn-primary" 
                                style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;">
                            โ ุชุญูู ูู ูููุฉ ุงููุฑูุฑ
                        </button>
                    </div>

                    <!-- Step 4: ูุฌุงุญ -->
                    <div id="linkStep4" style="display: none; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">โ</div>
                        <h3 style="color: #28a745; margin-bottom: 15px;">ุชู ุงูุฑุจุท ุจูุฌุงุญ!</h3>
                        <p style="color: #666; margin-bottom: 25px;">
                            ููููู ุงูุขู ุฅูุดุงุก ุงููุฑูุจุงุช ุชููุงุฆูุงู
                        </p>
                        <button type="button" onclick="closeLinkAccountModal()" class="btn btn-success" 
                                style="padding: 12px 40px;">
                            ูุชุงุจุนุฉ
                        </button>
                    </div>

                    <!-- Loading -->
                    <div id="linkLoading" style="display: none; text-align: center; padding: 30px 0;">
                        <div class="spinner-border" style="width: 3rem; height: 3rem; color: #667eea;" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p style="margin-top: 15px; color: #666;">ุฌุงุฑู ุงููุนุงูุฌุฉ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Code Verification Modal (ุงููุฏูู - ููุฅูุดุงุก ุงููุจุงุดุฑ) -->
    <div id="telegramCodeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h2 style="margin-bottom: 20px;">๐ฑ ุชุญูู ูู ุฑูู ุงููุงุชู</h2>
            
            <div id="codeStep1" style="display: block;">
                <p style="color: var(--text-secondary); margin-bottom: 25px;">
                    ุชู ุฅุฑุณุงู ููุฏ ุงูุชุญูู ุงููููู ูู <strong>5 ุฃุฑูุงู</strong> ุฅูู ูุงุชูู
                </p>
                <p style="font-size: 18px; font-weight: 600; margin-bottom: 30px;" id="phoneDisplay">
                    +966***
                </p>
                
                <div style="margin-bottom: 25px;">
                    <input type="text" id="verificationCode" 
                           placeholder="ุฃุฏุฎู ุงูููุฏ (12345)" 
                           maxlength="5"
                           style="width: 200px; font-size: 24px; text-align: center; letter-spacing: 8px; padding: 15px; border: 2px solid var(--primary-color); border-radius: 10px; font-weight: 600;">
                </div>
                
                <div style="margin-bottom: 25px; color: var(--text-secondary);">
                    <div id="timerDisplay" style="font-size: 16px; font-weight: 600; color: var(--primary-color);">
                        โฑ๏ธ 01:00
                    </div>
                    <p style="font-size: 14px; margin-top: 10px;">
                        ููููู ุงูุชุฎุทู ุจุนุฏ ุงูุชูุงุก ุงูุนุฏุงุฏ
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-primary" id="verifyCodeBtn" disabled>
                        โ ุชุญูู
                    </button>
                    <button type="button" class="btn btn-secondary" id="skipCodeBtn" disabled>
                        โญ๏ธ ุชุฎุทู
                    </button>
                </div>
            </div>
            
            <div id="codeStep2" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">โ</div>
                <h3 style="color: #28a745; margin-bottom: 15px;">ุชู ุงูุชุญูู ุจูุฌุงุญ!</h3>
                <p style="color: var(--text-secondary);">ุฌุงุฑู ุฅูุดุงุก ุงููุฑูุจุงุช...</p>
                <div class="spinner" style="margin: 20px auto;"></div>
            </div>
            
            <div id="passwordStep" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">๐</div>
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">ุงูุชุญูู ุจุฎุทูุชูู</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ุญุณุงุจู ูุญูู ุจุงูุชุญูู ุจุฎุทูุชูู. ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <input 
                        type="password" 
                        id="twoStepPassword" 
                        placeholder="ูููุฉ ุงููุฑูุฑ"
                        style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; text-align: center;"
                    />
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="skipPasswordVerification()" style="padding: 12px 30px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                        โ ุชุฎุทู
                    </button>
                    <button id="verifyPasswordBtn" onclick="verifyTwoStepPassword()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                        โ ุชุญูู
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- โ Config must load FIRST -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/app.js"></script>
    <script src="/assets/js/sections-api.js"></script>
    
    <script>
        // State Management
        const setupState = {
            level: '',
            gradeNumber: 0,
            schoolName: '',
            subject: '', // ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ
            sectionsCount: 5,
            sectionType: 'arabic', // ููุน ุงูุชุฑููู: arabic ุฃู numbers
            selectedSections: [], // ุงูุดูุนุจ ุงููุฎุชุงุฑุฉ (ูุซุงู: ['ุฃ', 'ุจ', 'ุฌ'] ุฃู [1, 2, 3])
            sectionLinks: []
        };

        // ============================================
        // localStorage Helper Functions
        // ============================================
        
        const STORAGE_KEY = 'pending_section_links';
        const MAX_AGE_HOURS = 24;
        
        /**
         * ุญูุธ ุงูุฑูุงุจุท ูู localStorage
         */
        function saveLinksToLocalStorage(links) {
            const data = {
                timestamp: Date.now(),
                version: '1.0',
                grade_info: {
                    level: setupState.level,
                    gradeNumber: setupState.gradeNumber,
                    schoolName: setupState.schoolName
                },
                sections: setupState.selectedSections,
                sectionType: setupState.sectionType,
                links: links
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                console.log('๐พ localStorage: ุชู ุญูุธ ุงูุฑูุงุจุท ุจูุฌุงุญ');
                console.log('   ุนุฏุฏ ุงูุฑูุงุจุท:', links.length);
                console.log('   ุงูุจูุงูุงุช:', data);
                return true;
            } catch (error) {
                console.error('โ localStorage: ูุดู ุงูุญูุธ', error);
                return false;
            }
        }
        
        /**
         * ูุฑุงุกุฉ ุงูุฑูุงุจุท ูู localStorage
         */
        function loadLinksFromLocalStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            
            if (!stored) {
                console.log('โน๏ธ localStorage: ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ');
                return null;
            }
            
            try {
                const data = JSON.parse(stored);
                
                console.log('๐ localStorage: ุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุญููุธุฉ');
                console.log('   ุงูุตู ุงููุญููุธ:', data.grade_info);
                console.log('   ุงูุตู ุงูุญุงูู:', {
                    level: setupState.level,
                    gradeNumber: setupState.gradeNumber,
                    schoolName: setupState.schoolName
                });
                
                // Validation: ุงูุชุญูู ูู ุชุทุงุจู ุงูุตู
                if (data.grade_info.level !== setupState.level ||
                    data.grade_info.gradeNumber !== setupState.gradeNumber) {
                    console.warn('โ๏ธ localStorage: ุงูุจูุงูุงุช ุงููุญููุธุฉ ูุตู ูุฎุชูู');
                    return null;
                }
                
                // Age check: ุงูุชุญูู ูู ุนูุฑ ุงูุจูุงูุงุช
                const ageInHours = (Date.now() - data.timestamp) / 3600000;
                console.log(`   ุนูุฑ ุงูุจูุงูุงุช: ${ageInHours.toFixed(1)} ุณุงุนุฉ`);
                
                if (ageInHours > MAX_AGE_HOURS) {
                    console.warn(`โ๏ธ localStorage: ุงูุจูุงูุงุช ูุฏููุฉ (>${MAX_AGE_HOURS}h)`);
                    clearPendingLinks();
                    return null;
                }
                
                console.log('โ localStorage: ุงูุจูุงูุงุช ุตุงูุญุฉ');
                console.log('   ุนุฏุฏ ุงูุฑูุงุจุท:', data.links.length);
                return data.links;
                
            } catch (error) {
                console.error('โ localStorage: ุฎุทุฃ ูู ุงููุฑุงุกุฉ', error);
                return null;
            }
        }
        
        /**
         * ุญุฐู ุงูุฑูุงุจุท ุงููุคูุชุฉ ูู localStorage
         */
        function clearPendingLinks() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                console.log('๐งน localStorage: ุชู ุญุฐู ุงูุฑูุงุจุท ุงููุคูุชุฉ');
                return true;
            } catch (error) {
                console.error('โ localStorage: ูุดู ุงูุญุฐู', error);
                return false;
            }
        }
        
        /**
         * ุงุณุชุฎุฑุงุฌ ุงูุฑูุงุจุท ูู ูุชุงุฆุฌ ุงูุฅูุดุงุก
         */
        function extractLinksFromResults(results) {
            console.log('๐ extractLinksFromResults - ุจุฏุก ุงูุงุณุชุฎุฑุงุฌ');
            console.log('   ุนุฏุฏ ุงููุชุงุฆุฌ:', results.length);
            
            const links = results
                .filter(r => r.success)
                .map((r, index) => {
                    // ูุญุงููุฉ ุฅูุฌุงุฏ ุงูุฑุงุจุท ูู ุฌููุน ุงูุญููู ุงูููููุฉ
                    const link = r.invite_link || r.link || r.telegram_link || r.group_link || '';
                    const groupId = r.chat_id || r.group_id || r.id;
                    
                    console.log(`   ุดุนุจุฉ ${r.section}:`, {
                        has_invite_link: !!r.invite_link,
                        has_link: !!r.link,
                        has_telegram_link: !!r.telegram_link,
                        has_group_link: !!r.group_link,
                        final_link: link ? link.substring(0, 30) + '...' : '(ูุงุฑุบ)',
                        chat_id: groupId
                    });
                    
                    return {
                        section_name: r.section,
                        platform: 'telegram',
                        telegram_link: link,
                        chat_id: groupId,
                        needs_link: !link  // ุนูุงูุฉ ุฃู ุงูุฑุงุจุท ููููุฏ
                    };
                });
            
            console.log('๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:', {
                total_results: results.length,
                successful: results.filter(r => r.success).length,
                extracted_links: links.length,
                with_links: links.filter(l => l.telegram_link).length,
                without_links: links.filter(l => !l.telegram_link).length
            });
            
            // ุชุญุฐูุฑ ุฅุฐุง ูู ูุฌุฏ ุฃู ุฑูุงุจุท
            if (links.length > 0 && links.filter(l => l.telegram_link).length === 0) {
                console.warn('โ๏ธ ุชุญุฐูุฑ: ุฌููุน ุงูุดูุนุจ ุจุฏูู ุฑูุงุจุท!');
                console.warn('๐ก ุงูุณุจุจ ุงููุญุชูู: API ูุง ูุฑุฌุน ุญูู invite_link');
                console.warn('๐ ุชุญูู ูู Backend Response ูู ุงูู Console ุฃุนูุงู');
            }
            
            return links;
        }

        // Grade configurations
        const gradeConfig = {
            elementary: { count: 6, label: 'ุงุจุชุฏุงุฆู' },
            middle: { count: 3, label: 'ูุชูุณุท' },
            high: { count: 3, label: 'ุซุงููู' }
        };

        // Current step
        let currentStep = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            auth.protectPage();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Step 1
            document.querySelectorAll('input[name="level"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    setupState.level = e.target.value;
                });
            });

            document.getElementById('nextStep1').addEventListener('click', () => {
                if (validateStep1()) {
                    setupState.schoolName = document.getElementById('schoolName').value.trim();
                    showGradeSelector();
                    nextStep();
                }
            });

            // Step 2
            document.getElementById('prevStep2').addEventListener('click', () => prevStep());
            document.getElementById('nextStep2').addEventListener('click', () => {
                if (validateStep2()) {
                    nextStep();
                }
            });

            // Step 3 (ุงููุงุฏุฉ)
            document.getElementById('prevStep3').addEventListener('click', () => prevStep());
            document.getElementById('nextStep3').addEventListener('click', () => {
                if (validateStep3()) {
                    setupState.subject = document.getElementById('subjectName').value.trim();
                    nextStep();
                }
            });

            // Step 4 (ุนุฏุฏ ุงูุดูุนุจ)
            document.getElementById('prevStep4').addEventListener('click', () => prevStep());
            document.getElementById('decreaseCount').addEventListener('click', () => changeSectionsCount(-1));
            document.getElementById('increaseCount').addEventListener('click', () => changeSectionsCount(1));
            document.getElementById('nextStep4').addEventListener('click', () => {
                setupState.sectionsCount = parseInt(document.getElementById('sectionsCount').textContent);
                const sectionType = document.querySelector('input[name="sectionType"]:checked').value;
                setupState.sectionType = sectionType;
                createSectionsCheckboxes(setupState.sectionsCount, sectionType);
                nextStep();
            });

            // Step 5 (ุงุฎุชูุงุฑ ุงูุดูุนุจ)
            document.getElementById('prevStep5').addEventListener('click', () => prevStep());
            document.getElementById('selectAllSections').addEventListener('click', selectAllSections);
            document.getElementById('deselectAllSections').addEventListener('click', deselectAllSections);
            document.getElementById('nextStep5').addEventListener('click', () => {
                if (validateSectionSelection()) {
                    nextStep();
                    // ุงูุชุญูู ูู session ุนูุฏ ุงูุฏุฎูู ูู Step 6
                    setTimeout(checkTelegramSession, 300);
                    // ุชูุนูู ุฒุฑ ุงูุชุงูู ูู Step 6
                    setTimeout(() => {
                        document.getElementById('nextStep6').disabled = false;
                    }, 500);
                }
            });

            // Step 6 (Telegram)
            document.getElementById('prevStep6').addEventListener('click', () => prevStep());
            document.getElementById('nextStep6').addEventListener('click', () => {
                showSummary();
                nextStep();
            });

            // Step 7 (ุงููุฑุงุฌุนุฉ ูุงูุญูุธ)
            document.getElementById('prevStep7').addEventListener('click', () => prevStep());
            document.getElementById('saveSetup').addEventListener('click', saveSetup);
        }

        function validateStep1() {
            if (!setupState.level) {
                UI.showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ', 'warning');
                return false;
            }
            const schoolName = document.getElementById('schoolName').value.trim();
            if (!schoolName) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุฏุฑุณุฉ', 'warning');
                return false;
            }
            return true;
        }

        function validateStep2() {
            if (!setupState.gradeNumber) {
                UI.showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตู ุงูุฏุฑุงุณู', 'warning');
                return false;
            }
            return true;
        }

        function validateStep3() {
            const subjectName = document.getElementById('subjectName').value.trim();
            if (!subjectName) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุงุฏุฉ', 'warning');
                return false;
            }
            if (subjectName.length < 3) {
                UI.showToast('ุงุณู ุงููุงุฏุฉ ูุฌุจ ุฃู ูููู 3 ุฃุญุฑู ุนูู ุงูุฃูู', 'warning');
                return false;
            }
            return true;
        }

        function validateStep4() {
            // ุงูุชุญูู ูู ุฃู ูู ุดุนุจุฉ ูุฏููุง ุฑุงุจุท ูุงุญุฏ ุนูู ุงูุฃูู
            const missingLinks = setupState.sectionLinks.filter(link => 
                !link.whatsapp_link && !link.telegram_link
            );
            
            if (missingLinks.length > 0) {
                UI.showToast('ูุฑุฌู ุฅุถุงูุฉ ุฑุงุจุท ูุงุญุฏ ุนูู ุงูุฃูู ููู ุดุนุจุฉ', 'warning');
                return false;
            }
            return true;
        }

        function showGradeSelector() {
            const config = gradeConfig[setupState.level];
            const selector = document.getElementById('gradeSelector');
            selector.innerHTML = '';

            for (let i = 1; i <= config.count; i++) {
                const html = `
                    <label class="grade-option">
                        <input type="radio" name="grade" value="${i}">
                        <div class="grade-card">
                            <span class="grade-number">${i}</span>
                            <span class="grade-label">ุงูุตู ${i}</span>
                        </div>
                    </label>
                `;
                selector.insertAdjacentHTML('beforeend', html);
            }

            // Add event listeners
            document.querySelectorAll('input[name="grade"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    setupState.gradeNumber = parseInt(e.target.value);
                });
            });
        }

        // ุชุบููุฑ ุนุฏุฏ ุงูุดูุนุจ
        function changeSectionsCount(delta) {
            const display = document.getElementById('sectionsCount');
            let count = parseInt(display.textContent) + delta;
            count = Math.max(1, Math.min(20, count));
            display.textContent = count;
        }

        // ุฅูุดุงุก checkboxes ููุดูุนุจ
        function createSectionsCheckboxes(count, type) {
            const arabicLetters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ', 'ู', 'ู', 'ุฒ', 'ุญ', 'ุท', 'ู', 'ู', 'ู', 'ู', 'ู', 'ุณ', 'ุน', 'ู', 'ุต', 'ู', 'ุฑ'];
            const container = document.getElementById('sectionsCheckboxList');
            container.innerHTML = '';
            
            // ุฅูุดุงุก checkboxes ุจูุงุกู ุนูู ุงูุนุฏุฏ ูุงูููุน
            for (let i = 0; i < count; i++) {
                const label = type === 'arabic' ? arabicLetters[i] : (i + 1);
                const checked = 'checked'; // ุฌููุนูุง ูุญุฏุฏุฉ ุงูุชุฑุงุถูุงู
                const html = `
                    <label style="display: flex; align-items: center; padding: 15px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" class="section-checkbox" value="${label}" ${checked} 
                               style="width: 20px; height: 20px; margin-left: 10px; cursor: pointer;"
                               onchange="updateSelectedSectionsCount()">
                        <span style="font-size: 18px; font-weight: 600;">ุดุนุจุฉ ${label}</span>
                    </label>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            
            updateSelectedSectionsCount();
        }
        
        // ุชุญุฏูุฏ ุฌููุน ุงูุดูุนุจ
        function selectAllSections() {
            document.querySelectorAll('.section-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedSectionsCount();
        }
        
        // ุฅูุบุงุก ุชุญุฏูุฏ ุฌููุน ุงูุดูุนุจ
        function deselectAllSections() {
            document.querySelectorAll('.section-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedSectionsCount();
        }
        
        // ุชุญุฏูุซ ุนุฏุฏ ุงูุดูุนุจ ุงููุฎุชุงุฑุฉ
        function updateSelectedSectionsCount() {
            const selected = document.querySelectorAll('.section-checkbox:checked');
            document.getElementById('selectedSectionsCount').textContent = selected.length;
            
            // ุชูุนูู/ุชุนุทูู ุฒุฑ ุงูุชุงูู
            document.getElementById('nextStep5').disabled = selected.length === 0;
        }
        
        // ุงูุชุญูู ูู ุงุฎุชูุงุฑ ุงูุดูุนุจ
        function validateSectionSelection() {
            const selected = document.querySelectorAll('.section-checkbox:checked');
            if (selected.length === 0) {
                UI.showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุดุนุจุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู', 'warning');
                return false;
            }
            
            // ุญูุธ ุงูุดูุนุจ ุงููุฎุชุงุฑุฉ
            setupState.selectedSections = Array.from(selected).map(cb => cb.value);
            
            console.log('โ ุชู ุญูุธ ุงูุดูุนุจ ุงููุฎุชุงุฑุฉ:', setupState.selectedSections);
            console.log('๐ setupState ุงููุงูู:', setupState);
            
            return true;
        }

        // ุฏุงูุฉ ุฅูุดุงุก ุงููุฑูุจุงุช ุชููุงุฆูุงู
        // ูุชุบูุฑุงุช ุนุงูุฉ ูู session management
        let pendingPhoneNumber = '';
        let pendingPhoneCodeHash = '';
        let pendingGroupsData = null;
        
        async function autoCreateTelegramGroups() {
            const subjectName = document.getElementById('subjectName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // Validation
            if (!subjectName) {
                UI.showToast('ูุฌุจ ุฅุฏุฎุงู ุงุณู ุงููุงุฏุฉ', 'warning');
                document.getElementById('subjectName').focus();
                return;
            }
            
            if (!phoneNumber) {
                UI.showToast('ูุฌุจ ุฅุฏุฎุงู ุฑูู ุงูุฌูุงู', 'warning');
                document.getElementById('phoneNumber').focus();
                return;
            }
            
            if (!phoneNumber.startsWith('+')) {
                UI.showToast('ุฑูู ุงูุฌูุงู ูุฌุจ ุฃู ูุจุฏุฃ ุจู +', 'warning');
                document.getElementById('phoneNumber').focus();
                return;
            }
            
            // ุจูุงุก ุงุณู ุงูุตู
            const levelLabels = { elementary: 'ุงุจุชุฏุงุฆู', middle: 'ูุชูุณุท', high: 'ุซุงููู' };
            const gradeNumbers = ['ุงูุฃูู', 'ุงูุซุงูู', 'ุงูุซุงูุซ', 'ุงูุฑุงุจุน', 'ุงูุฎุงูุณ', 'ุงูุณุงุฏุณ'];
            const levelLabel = levelLabels[setupState.level];
            const gradeText = gradeNumbers[setupState.gradeNumber - 1] || setupState.gradeNumber;
            const gradeName = `${gradeText} ${levelLabel}`;
            const sectionsCount = setupState.selectedSections.length;
            
            const confirmed = confirm(`โ๏ธ ุชุฃููุฏ ุงูุฅูุดุงุก\n\n` +
                `๐ ุงููุนูููุงุช:\n` +
                `โข ุงูุตู: ${gradeName}\n` +
                `โข ุงููุงุฏุฉ: ${subjectName}\n` +
                `โข ุนุฏุฏ ุงูุดูุนุจ: ${sectionsCount}\n` +
                `โข ุงูุดูุนุจ: ${setupState.selectedSections.join('ุ ')}\n` +
                `โข ุฑูู ุงูุฌูุงู: ${phoneNumber}\n\n` +
                `โ๏ธ ููุงุญุธุฉ ูููุฉ:\n` +
                `ุฅุฐุง ูุงูุช ุฃูู ูุฑุฉ ุชุณุชุฎุฏู ูุฐุง ุงูุฑููุ ูุฏ ููุฑุณู Telegram ููุฏ ุชุญูู (5 ุฃุฑูุงู) ููุงุชูู.\n` +
                `ุณูุธูุฑ ูู ูุฑุจุน ูุฅุฏุฎุงู ุงูููุฏ ููุฏุฉ 60 ุซุงููุฉ.\n\n` +
                `ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุชุงุจุนุฉุ`);
            
            if (!confirmed) {
                return;
            }
            
            // ุชุนุทูู ุงูุฒุฑ ูุฅุธูุงุฑ Spinner
            const btn = document.getElementById('autoCreateGroups');
            const text = document.getElementById('autoCreateText');
            const spinner = document.getElementById('autoCreateSpinner');
            
            btn.disabled = true;
            text.style.display = 'none';
            spinner.style.display = 'inline-block';
            
            // ุฅุธูุงุฑ Progress Bar
            document.getElementById('creationProgress').style.display = 'block';
            
            try {
                // ุงูุญุตูู ุนูู ุงูุชููู
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
                }
                
                // ุญูุธ ุงูุจูุงูุงุช ูุคูุชุงู
                pendingPhoneNumber = phoneNumber;
                pendingGroupsData = {
                    gradeName,
                    subjectName,
                    sectionsCount
                };
                
                // API URL - use global from config.js
                const API_URL = window.API_BASE || 'http://localhost:8000/api';
                
                // ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู Session ุฃู ุฅุฑุณุงู ููุฏ
                const response = await fetch(`${API_URL}/sections/telegram/session/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ');
                }
                
                // ุงูุชุญูู ูู ููุน ุงูุฑุฏ
                if (data.status === 'already_connected') {
                    // Session ููุฌูุฏ - ููุชูู ูุจุงุดุฑุฉ ููุฅูุดุงุก
                    await createGroupsDirectly(phoneNumber, gradeName, subjectName, sectionsCount);
                    return;
                }
                
                if (data.status === 'code_required' || data.phone_code_hash) {
                    // ูุญุชุงุฌ ููุฏ - ููุธูุฑ Modal
                    pendingPhoneCodeHash = data.phone_code_hash;
                    showCodeVerificationModal(data, phoneNumber, gradeName, subjectName, sectionsCount);
                    return;
                }
                
            } catch (error) {
                console.error('Error creating groups:', error);
                UI.showToast(error.message, 'error');
                
                // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
                btn.disabled = false;
                text.style.display = 'inline-block';
                spinner.style.display = 'none';
                document.getElementById('creationProgress').style.display = 'none';
            }
        }
        
        // ุฏุงูุฉ ุฅูุดุงุก ุงููุฑูุจุงุช ูุจุงุดุฑุฉ (ุจุนุฏ ุงูุชุฃูุฏ ูู ูุฌูุฏ session)
        async function createGroupsDirectly(phoneNumber, gradeName, subjectName, sectionsCount) {
            const API_URL = window.API_BASE || 'http://localhost:8000/api';
            const token = localStorage.getItem('access_token');
            
            // ุชุญููู ุงูุนุฏุฏ ุฅูู array ูู ุงูุญุฑูู ุงูุนุฑุจูุฉ
            const arabicLetters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ', 'ูู', 'ู', 'ุฒ', 'ุญ', 'ุท', 'ู'];
            const sectionsArray = arabicLetters.slice(0, sectionsCount);
            
            try {
                const response = await fetch(`${API_URL}/sections/telegram/create-groups-client/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        grade_name: gradeName,
                        subject_name: subjectName,
                        sections: sectionsArray  // ุฅุฑุณุงู array ุจุฏูุงู ูู ุฑูู
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุฅูุดุงุก ุงููุฑูุจุงุช');
                }
                
                // ูุนุงูุฌุฉ ุงููุชุงุฆุฌ
                handleGroupsCreation(data);
                
                // ุญูุธ ุงูุฑูุงุจุท
                setupState.sectionLinks = data.groups.map((group, index) => ({
                    section_number: index + 1,
                    platform: 'telegram',
                    whatsapp_link: '',
                    telegram_link: group.invite_link || '',
                    chat_id: group.chat_id
                }));
                
                document.getElementById('nextStep5').disabled = false;
                UI.showToast('ุชู ุฅูุดุงุก ุงููุฑูุจุงุช ุจูุฌุงุญ! ๐', 'success');
                
            } catch (error) {
                console.error('Error creating groups:', error);
                UI.showToast(error.message, 'error');
            } finally {
                const btn = document.getElementById('autoCreateGroups');
                btn.disabled = false;
                document.getElementById('autoCreateText').style.display = 'inline-block';
                document.getElementById('autoCreateSpinner').style.display = 'none';
                document.getElementById('creationProgress').style.display = 'none';
            }
        }
        
        // ุฅุธูุงุฑ modal ุงูุชุญูู ูู ุงูููุฏ
        let verificationTimer = null;
        
        function showCodeVerificationModal(data, phoneNumber, gradeName, subjectName, sections) {
            // ุญูุธ ุงูุจูุงูุงุช
            pendingGroupsData = {
                phoneNumber,
                gradeName,
                subjectName,
                sections,
                phone_code_hash: data.phone_code_hash
            };
            
            // ุนุฑุถ ุฑูู ุงููุงุชู
            document.getElementById('phoneDisplay').textContent = phoneNumber;
            
            // ุฅุธูุงุฑ Modal
            document.getElementById('telegramCodeModal').style.display = 'flex';
            document.getElementById('codeStep1').style.display = 'block';
            document.getElementById('codeStep2').style.display = 'none';
            
            // ุฅุฎูุงุก progress ูู ุงูุตูุญุฉ ุงูุฃุณุงุณูุฉ
            document.getElementById('creationProgress').style.display = 'none';
            const btn = document.getElementById('autoCreateGroups');
            btn.disabled = false;
            document.getElementById('autoCreateText').style.display = 'inline-block';
            document.getElementById('autoCreateSpinner').style.display = 'none';
            
            // ุจุฏุก Timer
            startVerificationTimer();
            
            // Event listeners
            document.getElementById('verificationCode').addEventListener('input', function(e) {
                const code = e.target.value;
                document.getElementById('verifyCodeBtn').disabled = code.length !== 5;
            });
            
            document.getElementById('verifyCodeBtn').onclick = verifyTelegramCode;
            document.getElementById('skipCodeBtn').onclick = skipCodeVerification;
        }
        
        // Timer ููุนุฏ ุงูุชูุงุฒูู
        function startVerificationTimer() {
            let seconds = 60;
            const timerDisplay = document.getElementById('timerDisplay');
            const skipBtn = document.getElementById('skipCodeBtn');
            
            verificationTimer = setInterval(() => {
                seconds--;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerDisplay.textContent = `โฑ๏ธ ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (seconds <= 0) {
                    clearInterval(verificationTimer);
                    timerDisplay.textContent = 'โฑ๏ธ 00:00';
                    skipBtn.disabled = false;
                    skipBtn.style.opacity = '1';
                    timerDisplay.style.color = '#dc3545';
                }
            }, 1000);
        }
        
        // ุงูุชุญูู ูู ุงูููุฏ
        async function verifyTelegramCode() {
            const code = document.getElementById('verificationCode').value;
            const API_URL = window.API_BASE || 'http://localhost:8000/api';
            const token = localStorage.getItem('access_token');
            
            try {
                document.getElementById('verifyCodeBtn').disabled = true;
                document.getElementById('verifyCodeBtn').textContent = 'ุฌุงุฑู ุงูุชุญูู...';
                
                // ุงุณุชุฎุฏุงู session/verify ุจุฏูุงู ูู verify-code
                const response = await fetch(`${API_URL}/sections/telegram/session/verify/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        code: code,
                        phone_number: pendingPhoneNumber,
                        phone_code_hash: pendingPhoneCodeHash
                    })
                });
                
                const data = await response.json();
                
                // ุงูุชุญูู ูู password_required
                if (data.status === 'password_required') {
                    // ูุญุชุงุฌ ูููุฉ ูุฑูุฑ Two-Step Verification
                    clearInterval(verificationTimer);
                    document.getElementById('codeStep1').style.display = 'none';
                    showPasswordInput();
                    return;
                }
                
                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || data.error || 'ูุดู ุงูุชุญูู ูู ุงูููุฏ');
                }
                
                // ูุฌุญ ุงูุชุญูู
                clearInterval(verificationTimer);
                document.getElementById('codeStep1').style.display = 'none';
                document.getElementById('codeStep2').style.display = 'block';
                
                // ุงูุขู ููุดุฆ ุงููุฑูุจุงุช ูุจุงุดุฑุฉ
                setTimeout(() => {
                    document.getElementById('telegramCodeModal').style.display = 'none';
                    const { gradeName, subjectName, sectionsCount } = pendingGroupsData;
                    createGroupsDirectly(pendingPhoneNumber, gradeName, subjectName, sectionsCount);
                }, 2000);
                
            } catch (error) {
                console.error('Error verifying code:', error);
                UI.showToast(error.message, 'error');
                document.getElementById('verifyCodeBtn').disabled = false;
                document.getElementById('verifyCodeBtn').textContent = 'โ ุชุญูู';
            }
        }
        
        // ุชุฎุทู ุงูุชุญูู ูู ุงูููุฏ
        function skipCodeVerification() {
            clearInterval(verificationTimer);
            document.getElementById('telegramCodeModal').style.display = 'none';
            UI.showToast('ุชู ุชุฎุทู ุงูุชุญูู. ููููู ุงููุญุงููุฉ ูุงุญูุงู.', 'info');
        }
        
        // ุฅุธูุงุฑ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ
        function showPasswordInput() {
            document.getElementById('passwordStep').style.display = 'block';
            document.getElementById('twoStepPassword').focus();
        }
        
        // ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ
        async function verifyTwoStepPassword() {
            const password = document.getElementById('twoStepPassword').value;
            const API_URL = window.API_BASE || 'http://localhost:8000/api';
            const token = localStorage.getItem('access_token');
            
            if (!password) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ', 'warning');
                return;
            }
            
            try {
                document.getElementById('verifyPasswordBtn').disabled = true;
                document.getElementById('verifyPasswordBtn').textContent = 'ุฌุงุฑู ุงูุชุญูู...';
                
                const response = await fetch(`${API_URL}/sections/telegram/session/password/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        phone_number: pendingPhoneNumber,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || data.error || 'ูุดู ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ');
                }
                
                // ูุฌุญ ุงูุชุญูู
                document.getElementById('passwordStep').style.display = 'none';
                document.getElementById('codeStep2').style.display = 'block';
                
                // ุฅูุดุงุก ุงููุฑูุจุงุช
                setTimeout(() => {
                    document.getElementById('telegramCodeModal').style.display = 'none';
                    const { gradeName, subjectName, sectionsCount } = pendingGroupsData;
                    createGroupsDirectly(pendingPhoneNumber, gradeName, subjectName, sectionsCount);
                }, 2000);
                
            } catch (error) {
                console.error('Error verifying password:', error);
                UI.showToast(error.message, 'error');
                document.getElementById('verifyPasswordBtn').disabled = false;
                document.getElementById('verifyPasswordBtn').textContent = 'โ ุชุญูู';
            }
        }
        
        // ุชุฎุทู ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ
        function skipPasswordVerification() {
            document.getElementById('telegramCodeModal').style.display = 'none';
            UI.showToast('ุชู ุชุฎุทู ุงูุชุญูู. ูุฌุจ ุฅููุงู ุงูุชุญูู ุจุฎุทูุชูู ูู ุฅุนุฏุงุฏุงุช Telegram.', 'info');
        }
        
        // ูุนุงูุฌุฉ ูุชุงุฆุฌ ุงูุฅูุดุงุก
        function handleGroupsCreation(data) {
            const resultsDiv = document.getElementById('creationResults');
            const groupsList = document.getElementById('groupsList');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // ุชุญุฏูุซ Progress Bar
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            
            let html = '<table class="table" style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f8f9fa;">';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">ุงูุดุนุจุฉ</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">ุงูุญุงูุฉ</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">ุฑุงุจุท ุงููุฑูุจ</th></tr></thead><tbody>';
            
            const arabicLetters = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ', 'ูู', 'ู', 'ุฒ', 'ุญ', 'ุท', 'ู'];
            let newCount = 0, existingCount = 0;
            
            data.groups.forEach((group, index) => {
                if (group.success) {
                    const isExisting = group.already_exists;
                    const icon = isExisting ? 'โป๏ธ' : 'โจ';
                    const status = isExisting ? 'ููุฌูุฏ ูุณุจูุงู' : 'ุชู ุงูุฅูุดุงุก';
                    const readOnlyBadge = group.read_only ? ' <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">๐ ูููุฑุงุกุฉ ููุท</span>' : '';
                    const rowColor = isExisting ? '#fff3cd' : '#d4edda';
                    
                    if (isExisting) existingCount++;
                    else newCount++;
                    
                    const link = `<a href="${group.invite_link}" target="_blank" style="color: #667eea;">ูุชุญ ุงููุฑูุจ</a>`;
                    
                    html += `<tr style="background: ${rowColor}">
                        <td style="padding: 10px; border: 1px solid #ddd;"><strong>ุดุนุจุฉ ${arabicLetters[index]}</strong></td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${icon} ${status}${readOnlyBadge}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${link}</td>
                    </tr>`;
                } else {
                    html += `<tr style="background: #f8d7da">
                        <td style="padding: 10px; border: 1px solid #ddd;"><strong>ุดุนุจุฉ ${arabicLetters[index]}</strong></td>
                        <td style="padding: 10px; border: 1px solid #ddd;">โ ูุดู</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${group.error}</td>
                    </tr>`;
                }
            });
            
            html += '</tbody></table>';
            
            // ุฅุธูุงุฑ ุงูุฅุญุตุงุฆูุงุช ุงููุญุณููุฉ
            html += `<div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px;">
                <strong>๐ ุงูุฅุญุตุงุฆูุงุช:</strong><br>
                โจ ูุฑูุจุงุช ุฌุฏูุฏุฉ: ${newCount}<br>
                โป๏ธ ูุฑูุจุงุช ููุฌูุฏุฉ: ${existingCount}<br>
                โ ูุดู: ${data.statistics.failed}<br>
                ๐ ุงูุฅุฌูุงูู: ${data.statistics.total}
            </div>`;
            
            // ุฅุถุงูุฉ ููุงุญุธุฉ ุนู Read-Only
            html += `<div style="margin-top: 10px; padding: 12px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 5px;">
                <strong>๐ ูุถุน ุงููุฑุงุกุฉ ููุท ูููุนูู:</strong><br>
                <span style="font-size: 13px; color: #155724;">ุงูุฃุนุถุงุก ูุง ูููููู ุฅุฑุณุงู ุฑุณุงุฆู. ููุท ุงููุฏูุฑูู ูุณุชุทูุนูู ุงููุดุฑ ูู ุงููุฑูุจุงุช.</span>
            </div>`;
            
            groupsList.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // ุฅุฎูุงุก ุฒุฑ ุงูุฅูุดุงุก
            document.getElementById('autoCreateGroups').style.display = 'none';
            document.getElementById('subjectName').disabled = true;
        }

        function showSummary() {
            console.log('๐ Step 6: showSummary - ุจุฏุก ุนุฑุถ ุงูููุฎุต');
            
            // ============================================
            // ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงูุฑูุงุจุท ูู localStorage
            // ============================================
            
            console.log('๐ ูุญุต setupState.sectionLinks:', {
                exists: !!setupState.sectionLinks,
                length: setupState.sectionLinks?.length || 0,
                empty: !setupState.sectionLinks || setupState.sectionLinks.length === 0
            });
            
            // ุฅุฐุง ูุงูุช ุงูุฑูุงุจุท ูุงุฑุบุฉุ ุญุงูู ุงุณุชุนุงุฏุชูุง ูู localStorage
            if (!setupState.sectionLinks || setupState.sectionLinks.length === 0) {
                console.log('โ๏ธ setupState.sectionLinks ูุงุฑุบุฉุ ูุญุงููุฉ ุงูุงุณุชุฑุฌุงุน ูู localStorage...');
                
                const storedLinks = loadLinksFromLocalStorage();
                
                if (storedLinks && storedLinks.length > 0) {
                    setupState.sectionLinks = storedLinks;
                    console.log('โ ุชู ุงุณุชุนุงุฏุฉ ุงูุฑูุงุจุท ูู localStorage ุจูุฌุงุญ!');
                    UI.showToast('โ ุชู ุงุณุชุนุงุฏุฉ ุฑูุงุจุท ุงููุฑูุจุงุช', 'success', 3000);
                } else {
                    console.warn('โ ูุง ุชูุฌุฏ ุฑูุงุจุท ูุญููุธุฉ ูู localStorage');
                }
            } else {
                console.log('โ setupState.sectionLinks ููุฌูุฏุฉ:', setupState.sectionLinks.length);
            }
            
            const grid = document.getElementById('summaryGrid');
            const levelLabel = gradeConfig[setupState.level].label;
            const actualSectionsCount = setupState.selectedSections.length;
            
            console.log('๐ ุงูุจูุงูุงุช ุงูููุงุฆูุฉ:', {
                level: setupState.level,
                gradeNumber: setupState.gradeNumber,
                schoolName: setupState.schoolName,
                sectionsCount: actualSectionsCount,
                linksCount: setupState.sectionLinks.length
            });
            
            grid.innerHTML = `
                <div class="summary-card">
                    <h4>ุงููุฏุฑุณุฉ</h4>
                    <div class="summary-value">${setupState.schoolName}</div>
                </div>
                <div class="summary-card">
                    <h4>ุงููุฑุญูุฉ</h4>
                    <div class="summary-value">${levelLabel}</div>
                </div>
                <div class="summary-card">
                    <h4>ุงูุตู</h4>
                    <div class="summary-value">${setupState.gradeNumber}</div>
                </div>
                <div class="summary-card">
                    <h4>ุงููุงุฏุฉ</h4>
                    <div class="summary-value">๐ ${setupState.subject}</div>
                </div>
                <div class="summary-card">
                    <h4>ุนุฏุฏ ุงูุดูุนุจ</h4>
                    <div class="summary-value">${actualSectionsCount}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        ุงูุดูุนุจ: ${setupState.selectedSections.join('ุ ')}
                    </div>
                </div>
            `;
            
            // ููุก ุฌุฏูู ูุนุงููุฉ ุงูุดูุนุจ
            populateSectionsPreviewTable();
        }

        function populateSectionsPreviewTable() {
            const tbody = document.getElementById('sectionsPreviewTableBody');
            const levelLabel = gradeConfig[setupState.level].label;
            const gradeDisplay = `${levelLabel} - ุงูุตู ${setupState.gradeNumber}`;
            
            console.log('๐ populateSectionsPreviewTable - ุงูุจูุงูุงุช:');
            console.log('  selectedSections:', setupState.selectedSections);
            console.log('  sectionLinks:', setupState.sectionLinks);
            
            // ุชุญุฐูุฑ ุฅุฐุง ูุงูุช ุงูุฑูุงุจุท ูุงุฑุบุฉ
            if (!setupState.sectionLinks || setupState.sectionLinks.length === 0) {
                console.warn('โ๏ธ setupState.sectionLinks ูุงุฑุบุฉ! ูุฌุจ ุฅูุดุงุก ุงููุฑูุจุงุช ูู ุงูุฎุทูุฉ ุงูุฎุงูุณุฉ ุฃููุงู.');
            }
            
            let html = '';
            let sectionsWithLinks = 0;
            let sectionsWithoutLinks = 0;
            
            setupState.selectedSections.forEach((sectionName, index) => {
                // ุงูุจุญุซ ุนู ุฑุงุจุท Telegram ููุฐู ุงูุดุนุจุฉ
                const linkInfo = setupState.sectionLinks.find(
                    link => link.section_name === sectionName
                );
                
                console.log(`  ุดุนุจุฉ ${sectionName}: linkInfo =`, linkInfo);
                
                const telegramLink = linkInfo?.telegram_link || '';
                const hasLink = telegramLink !== '';
                
                if (hasLink) sectionsWithLinks++;
                else sectionsWithoutLinks++;
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.05)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">${index + 1}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-color);">${gradeDisplay}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--primary-color);">ุดุนุจุฉ ${sectionName}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${hasLink 
                                ? `<a href="${telegramLink}" target="_blank" style="color: #0088cc; text-decoration: none; word-break: break-all; font-size: 13px;" title="ูุชุญ ุงูุฑุงุจุท">
                                    ๐ฑ ${telegramLink.length > 40 ? telegramLink.substring(0, 40) + '...' : telegramLink}
                                   </a>`
                                : '<span style="color: #f59e0b; font-weight: 600;">โ๏ธ ูู ูุชู ุฅุฏุฎุงู ุฑุงุจุท</span>'
                            }
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${hasLink 
                                ? '<span style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">โ ุฌุงูุฒ</span>'
                                : '<span style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">โ๏ธ ุจุฏูู ุฑุงุจุท</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            // ุฅุถุงูุฉ ุตู ุงูููุฎุต
            html += `
                <tr style="background: rgba(102, 126, 234, 0.05); font-weight: 600;">
                    <td colspan="3" style="padding: 15px; text-align: center; color: var(--primary-color);">
                        ๐ ุงูุฅุฌูุงูู: ${setupState.selectedSections.length} ุดุนุจุฉ
                    </td>
                    <td style="padding: 15px; text-align: center; color: #10b981;">
                        โ ${sectionsWithLinks} ูุน ุฑูุงุจุท
                    </td>
                    <td style="padding: 15px; text-align: center; color: #f59e0b;">
                        โ๏ธ ${sectionsWithoutLinks} ุจุฏูู ุฑูุงุจุท
                    </td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // ============================================
            // ุนุฑุถ ุฑุณุงูุฉ ุชูุถูุญูุฉ ุฅุฐุง ูุงูุช ุฌููุน ุงูุฑูุงุจุท ููููุฏุฉ
            // ============================================
            if (sectionsWithoutLinks > 0 && sectionsWithLinks === 0) {
                const warningDiv = document.getElementById('sectionsPreviewContainer');
                const existingWarning = document.getElementById('linksWarningMessage');
                
                if (!existingWarning) {
                    const warningMessage = document.createElement('div');
                    warningMessage.id = 'linksWarningMessage';
                    warningMessage.style.cssText = `
                        margin-top: 15px;
                        padding: 15px 20px;
                        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
                        border: 1px solid rgba(245, 158, 11, 0.3);
                        border-radius: 12px;
                        color: #92400e;
                        font-size: 14px;
                        line-height: 1.6;
                    `;
                    
                    warningMessage.innerHTML = `
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">๐ก</span>
                            <div>
                                <strong style="display: block; margin-bottom: 8px; color: #b45309;">ููุงุญุธุฉ ูุงูุฉ:</strong>
                                <p style="margin: 0 0 8px 0;">
                                    ุงููุฑูุจุงุช ุชู ุฅูุดุงุคูุง ุจูุฌุงุญ ูู Telegram โุ ููู ุงูุฑูุงุจุท ูู ุชุธูุฑ ูู ูุฐู ุงูุฎุทูุฉ.
                                </p>
                                <p style="margin: 0; opacity: 0.9;">
                                    <strong>ูุง ุชููู!</strong> ุจุนุฏ ุงูุญูุธุ ุณุชุฌุฏ ุฌููุน ุงูุฑูุงุจุท ูู ุตูุญุฉ 
                                    <strong style="color: var(--primary-color);">ุฅุฏุงุฑุฉ ุงูุตููู</strong>
                                    ูููููู ูุณุฎูุง ููุดุงุฑูุชูุง ูุน ุงูุทูุงุจ.
                                </p>
                            </div>
                        </div>
                    `;
                    
                    warningDiv.appendChild(warningMessage);
                    console.log('๐ก ุชู ุนุฑุถ ุฑุณุงูุฉ ุชูุถูุญูุฉ ูููุณุชุฎุฏู');
                }
            }
        }

        function displaySectionsResults(grade, sectionsWithLinks) {
            const container = document.getElementById('sectionsCards');
            const levelLabel = gradeConfig[grade.level].label;
            
            let html = `
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 2px solid var(--success-color);">
                    <h4 style="color: var(--success-color); margin-bottom: 10px;">๐ ${grade.school_name}</h4>
                    <p style="color: var(--text-secondary); margin: 0;">${levelLabel} - ุงูุตู ${grade.grade_number}</p>
                </div>
                
                <div style="display: grid; gap: 15px;">
            `;
            
            sectionsWithLinks.forEach(section => {
                html += `
                    <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: var(--primary-color); font-size: 18px;">
                                ๐ ุดุนุจุฉ ${section.name}
                            </h4>
                            ${section.link ? `
                                <span style="background: var(--success-color); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                                    โ ุชู ุงูุฑุจุท
                                </span>
                            ` : `
                                <span style="background: var(--warning-color); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                                    โ๏ธ ุจุฏูู ุฑุงุจุท
                                </span>
                            `}
                        </div>
                        
                        ${section.link ? `
                            <div style="background: rgba(0, 136, 204, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-secondary); font-weight: 600;">
                                    ๐ฑ ุฑุงุจุท ุชูููุฌุฑุงู:
                                </p>
                                <a href="${section.link}" target="_blank" style="color: #0088cc; word-break: break-all; font-size: 14px; text-decoration: none;">
                                    ${section.link}
                                </a>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button 
                                    class="btn btn-sm" 
                                    style="flex: 1; background: #0088cc; color: white;"
                                    onclick="window.open('${section.link}', '_blank')"
                                    title="ูุชุญ ูู ุชูููุฌุฑุงู">
                                    โ๏ธ ูุชุญ ุงูุชุทุจูู
                                </button>
                                <button 
                                    class="btn btn-sm" 
                                    style="flex: 1; background: var(--secondary-color); color: white;"
                                    onclick="copyLinkToClipboard('${section.link}', '${section.name}')"
                                    title="ูุณุฎ ุงูุฑุงุจุท">
                                    ๐ ูุณุฎ ุงูุฑุงุจุท
                                </button>
                            </div>
                        ` : `
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px; text-align: center; padding: 15px;">
                                ูุง ููุฌุฏ ุฑุงุจุท ุชูููุฌุฑุงู ููุฐู ุงูุดุนุจุฉ
                            </p>
                        `}
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="margin-top: 25px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                        ๐ ุณูุชู ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ ุจุนุฏ 5 ุซูุงู...
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function copyLinkToClipboard(link, sectionName) {
            try {
                await navigator.clipboard.writeText(link);
                UI.showToast(`โ ุชู ูุณุฎ ุฑุงุจุท ุดุนุจุฉ ${sectionName}`, 'success');
            } catch (error) {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = link;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                UI.showToast(`โ ุชู ูุณุฎ ุฑุงุจุท ุดุนุจุฉ ${sectionName}`, 'success');
            }
        }

        async function saveSetup() {
            const btn = document.getElementById('saveSetup');
            btn.disabled = true;
            btn.textContent = 'ุฌุงุฑู ุงูุญูุธ...';
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                // 1. ุฅูุดุงุก ุงูุตู ูุน ุงูุดูุนุจ ุงููุฎุชุงุฑุฉ ููุท
                const gradeData = {
                    level: setupState.level,
                    grade_number: setupState.gradeNumber,
                    school_name: setupState.schoolName,
                    subject: setupState.subject,  // ๐ ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ
                    sections_list: setupState.selectedSections  // ๐ ุฅุฑุณุงู ุงููุงุฆูุฉ ุงููุฎุชุงุฑุฉ ููุท
                };

                console.log('๐ค Sending grade data:', gradeData);
                console.log('โ Selected sections:', setupState.selectedSections);

                const gradeResult = await sectionsAPI.setupGrade(gradeData);
                console.log('โ Grade created:', gradeResult);
                console.log(`๐ Created ${gradeResult.sections_count} sections`);
                
                // 2. ุฅุนุฏุงุฏ ุฑูุงุจุท ุงูุดูุนุจ
                const sections = await sectionsAPI.getGradeSections(gradeResult.grade.id);
                console.log('๐ Sections retrieved:', sections);
                
                // ูุทุงุจูุฉ ูู section ูุน ุงูุฑุงุจุท ุงูุตุญูุญ ุจูุงุกู ุนูู ุงุณู ุงูุดุนุจุฉ
                const sectionsWithLinks = [];
                for (const section of sections.sections) {
                    const sectionName = section.section_name;
                    
                    // ุงูุจุญุซ ุนู ุงูุฑุงุจุท ุงูููุงุณุจ ููุฐู ุงูุดุนุจุฉ
                    const linkInfo = setupState.sectionLinks.find(link => link.section_name === sectionName);
                    
                    let telegramLink = null;
                    if (linkInfo && linkInfo.telegram_link) {
                        const linkData = {
                            section_id: section.id,
                            platform: 'telegram',
                            telegram_link: linkInfo.telegram_link,
                            chat_id: linkInfo.chat_id  // โ ุฅุถุงูุฉ chat_id
                        };
                        
                        console.log('โ Setting up link for section:', sectionName, linkData);
                        await sectionsAPI.setupSectionLink(linkData);
                        telegramLink = linkInfo.telegram_link;
                    }
                    
                    sectionsWithLinks.push({
                        name: sectionName,
                        link: telegramLink
                    });
                }

                // ุฅุฎูุงุก ุงูุฌุฏูู ูุนุฑุถ ุงููุชุงุฆุฌ
                document.getElementById('sectionsPreviewContainer').style.display = 'none';
                document.getElementById('sectionsResultsList').style.display = 'block';
                
                // ููุก ุจุทุงูุงุช ุงูุดูุนุจ
                displaySectionsResults(gradeResult.grade, sectionsWithLinks);
                
                // ุชุบููุฑ ูุต ุงูุฒุฑ
                btn.textContent = 'โ ุชู ุงูุญูุธ ุจูุฌุงุญ';
                btn.style.background = 'var(--success-color)';
                
                // ============================================
                // ุชูุธูู localStorage ุจุนุฏ ุงูุญูุธ ุงููุงุฌุญ
                // ============================================
                clearPendingLinks();
                console.log('โ ุชู ุญุฐู ุงูุจูุงูุงุช ุงููุคูุชุฉ ูู localStorage');
                
                UI.showToast('โ ุชู ุฅูุดุงุก ุงูุตู ูุงูุดูุนุจ ุจูุฌุงุญ!', 'success', 3000);
                
                // ุฅุนุงุฏุฉ ุชูุฌูู ุจุนุฏ 5 ุซูุงูู
                setTimeout(() => {
                    window.location.href = '/pages/sections-manage.html';
                }, 5000);

            } catch (error) {
                console.error('Save setup error:', error);
                UI.showToast('ุญุฏุซ ุฎุทุฃ: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = '๐พ ุญูุธ ุงูุตู ูุงูุดูุนุจ';
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function nextStep() {
            document.getElementById(`step${currentStep}`).style.display = 'none';
            currentStep++;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            updateStepIndicator();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            document.getElementById(`step${currentStep}`).style.display = 'none';
            currentStep--;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            updateStepIndicator();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // ุชูุนูู ุฒุฑ ุงูุชุงูู ูู Step 6 (ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุนุงุฆุฏ ูู Step 7)
            if (currentStep === 6) {
                document.getElementById('nextStep6').disabled = false;
            }
        }

        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }
        
        // ====== Telegram Session Management ======
        
        const API_URL = window.API_BASE || 'http://localhost:8000/api';
        // FastAPI Telegram Service (optional - if deployed separately)
        const FASTAPI_TELEGRAM_URL = window.FASTAPI_TELEGRAM_URL || null;
        const USE_FASTAPI = !!FASTAPI_TELEGRAM_URL;
        
        let linkedPhoneNumber = '';
        let phoneCodeHash = '';
        let linkTimer = null;
        
        // ุงูุชุญูู ูู ุญุงูุฉ Session ุนูุฏ ุฏุฎูู Step 5
        async function checkTelegramSession() {
            const phone = localStorage.getItem('telegram_phone');
            
            if (!phone) {
                showDisconnectedState();
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_URL}/sections/telegram/session/status/?phone_number=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.is_connected) {
                    linkedPhoneNumber = phone;
                    showConnectedState(phone);
                } else {
                    showDisconnectedState();
                }
            } catch (error) {
                console.error('Error checking session:', error);
                showDisconnectedState();
            }
        }
        
        // ุนุฑุถ ุญุงูุฉ ูุชุตู
        function showConnectedState(phone) {
            const statusDiv = document.getElementById('telegramSessionStatus');
            statusDiv.className = 'telegram-session-status connected';
            
            const statusIcon = statusDiv.querySelector('.status-icon');
            const statusMessage = document.getElementById('sessionStatusMessage');
            const linkBtn = document.getElementById('linkAccountBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            statusIcon.textContent = 'โ';
            statusMessage.textContent = `ูุชุตู ุจุงูุญุณุงุจ: ${phone}`;
            linkBtn.style.display = 'none';
            disconnectBtn.style.display = 'inline-block';
            
            // ุชูุนูู ูุณู ุงูุฅูุดุงุก
            const createSection = document.getElementById('createGroupsSection');
            createSection.style.opacity = '1';
            createSection.style.pointerEvents = 'auto';
            
            // ุชุญุฏูุซ ุงูููุฎุต
            updateCreationSummary();
        }
        
        // ุนุฑุถ ุญุงูุฉ ุบูุฑ ูุชุตู
        function showDisconnectedState() {
            const statusDiv = document.getElementById('telegramSessionStatus');
            statusDiv.className = 'telegram-session-status disconnected';
            
            const statusIcon = statusDiv.querySelector('.status-icon');
            const statusMessage = document.getElementById('sessionStatusMessage');
            const linkBtn = document.getElementById('linkAccountBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            statusIcon.textContent = 'โ๏ธ';
            statusMessage.textContent = 'ูุฑุฌู ุฑุจุท ุญุณุงุจู ุจู Telegram ุฃููุงู';
            linkBtn.style.display = 'inline-block';
            disconnectBtn.style.display = 'none';
            
            // ุชุนุทูู ูุณู ุงูุฅูุดุงุก
            const createSection = document.getElementById('createGroupsSection');
            createSection.style.opacity = '0.5';
            createSection.style.pointerEvents = 'none';
        }
        
        // ูุชุญ Modal ุฑุจุท ุงูุญุณุงุจ
        function showLinkAccountModal() {
            document.getElementById('linkAccountModal').style.display = 'flex';
            resetLinkModal();
        }
        
        // ุฅุบูุงู Modal
        function closeLinkAccountModal() {
            document.getElementById('linkAccountModal').style.display = 'none';
            if (linkTimer) {
                clearInterval(linkTimer);
            }
            
            // ุฅุนุงุฏุฉ ูุญุต ุงูุญุงูุฉ
            checkTelegramSession();
        }
        
        // ุฅุนุงุฏุฉ ุชุนููู Modal
        function resetLinkModal() {
            document.getElementById('linkStep1').style.display = 'block';
            document.getElementById('linkStep2').style.display = 'none';
            document.getElementById('linkStep3').style.display = 'none';
            document.getElementById('linkStep4').style.display = 'none';
            document.getElementById('linkLoading').style.display = 'none';
            document.getElementById('linkPhoneNumber').value = '';
            document.getElementById('linkVerificationCode').value = '';
            document.getElementById('link2FAPassword').value = '';
        }
        
        // ุฅุฑุณุงู ููุฏ ุงูุชุญูู
        async function sendVerificationCode() {
            const phone = document.getElementById('linkPhoneNumber').value.trim();
            
            if (!phone) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุงุชู', 'warning');
                return;
            }
            
            if (!phone.startsWith('+')) {
                UI.showToast('ุฑูู ุงููุงุชู ูุฌุจ ุฃู ูุจุฏุฃ ุจู +', 'warning');
                return;
            }
            
            linkedPhoneNumber = phone;
            
            // ุฅุธูุงุฑ Loading
            document.getElementById('linkStep1').style.display = 'none';
            document.getElementById('linkLoading').style.display = 'block';
            
            try {
                let response, data;
                
                if (USE_FASTAPI) {
                    // ุงุณุชุฎุฏุงู FastAPI ูุจุงุดุฑุฉ
                    console.log('๐ก Using FastAPI Telegram Service:', FASTAPI_TELEGRAM_URL);
                    response = await fetch(`${FASTAPI_TELEGRAM_URL}/telegram/send-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ phone_number: phone })
                    });
                    data = await response.json();
                    
                    // ุชุญููู response ูู FastAPI ูุตูุบุฉ Django
                    if (data.status === 'code_sent') {
                        data.status = 'code_required';
                    }
                } else {
                    // ุงุณุชุฎุฏุงู Django (ุงูุญุงูู)
                    console.log('๐ก Using Django Backend:', API_URL);
                    const token = localStorage.getItem('access_token');
                    response = await fetch(`${API_URL}/sections/telegram/session/login/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ phone_number: phone })
                    });
                    data = await response.json();
                }
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุฅุฑุณุงู ุงูููุฏ');
                }
                
                if (data.status === 'already_connected') {
                    // ูุชุตู ุจุงููุนู
                    linkedPhoneNumber = phone;
                    localStorage.setItem('telegram_phone', phone);
                    document.getElementById('linkLoading').style.display = 'none';
                    document.getElementById('linkStep4').style.display = 'block';
                    setTimeout(closeLinkAccountModal, 2000);
                    return;
                }
                
                if (data.status === 'code_required' || data.phone_code_hash) {
                    phoneCodeHash = data.phone_code_hash;
                    
                    // ุงูุงูุชูุงู ูุฎุทูุฉ ุงูููุฏ
                    document.getElementById('linkLoading').style.display = 'none';
                    document.getElementById('linkStep2').style.display = 'block';
                    document.getElementById('linkPhoneDisplay').textContent = phone;
                    const deliveryInfo = document.getElementById('deliveryInfo');
                    if (deliveryInfo) {
                        const method = (data.delivery || '-').toString();
                        deliveryInfo.textContent = `ุทุฑููุฉ ุงูุฅุฑุณุงู: ${method}`;
                    }
                    const resendBtn = document.getElementById('linkResendBtn');
                    if (resendBtn) {
                        resendBtn.disabled = true;
                        resendBtn.textContent = '๐ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูููุฏ';
                    }
                    
                    // ุจุฏุก ุงูุนุฏ ุงูุชูุงุฒูู
                    startLinkTimer();
                    
                    UI.showToast('ุชู ุฅุฑุณุงู ุงูููุฏ ุฅูู Telegram', 'success');
                }
                
            } catch (error) {
                console.error('Error sending code:', error);
                UI.showToast(error.message, 'error');
                document.getElementById('linkLoading').style.display = 'none';
                document.getElementById('linkStep1').style.display = 'block';
            }
        }
        
        // ุจุฏุก ุนุฏุงุฏ ุงูููุฏ
        function startLinkTimer() {
            let timeLeft = 60;
            const timerValue = document.getElementById('linkTimerValue');
            
            linkTimer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(linkTimer);
                    timerValue.textContent = 'ุงูุชูู ุงูููุช';
                    const resendBtn = document.getElementById('linkResendBtn');
                    if (resendBtn) {
                        resendBtn.disabled = false;
                    }
                }
            }, 1000);
        }
        
        // ุงูุชุญูู ูู ุงูููุฏ
        async function verifyCode() {
            const code = document.getElementById('linkVerificationCode').value.trim();
            
            if (!code || code.length !== 5) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ููุฏ ูููู ูู 5 ุฃุฑูุงู', 'warning');
                return;
            }
            
            // ุฅุธูุงุฑ Loading
            document.getElementById('linkStep2').style.display = 'none';
            document.getElementById('linkLoading').style.display = 'block';
            
            try {
                let response, data;
                
                if (USE_FASTAPI) {
                    // ุงุณุชุฎุฏุงู FastAPI
                    response = await fetch(`${FASTAPI_TELEGRAM_URL}/telegram/verify-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone_number: linkedPhoneNumber,
                            code: code,
                            phone_code_hash: phoneCodeHash
                        })
                    });
                    data = await response.json();
                } else {
                    // ุงุณุชุฎุฏุงู Django
                    const token = localStorage.getItem('access_token');
                    response = await fetch(`${API_URL}/sections/telegram/session/verify/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            phone_number: linkedPhoneNumber,
                            code: code,
                            phone_code_hash: phoneCodeHash
                        })
                    });
                    data = await response.json();
                }
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุงูุชุญูู');
                }
                
                if (data.status === 'password_required') {
                    // ูุญุชุงุฌ ูููุฉ ูุฑูุฑ 2FA
                    document.getElementById('linkLoading').style.display = 'none';
                    document.getElementById('linkStep3').style.display = 'block';
                    return;
                }
                
                if (data.status === 'success') {
                    // ูุฌุญ!
                    localStorage.setItem('telegram_phone', linkedPhoneNumber);
                    document.getElementById('linkLoading').style.display = 'none';
                    document.getElementById('linkStep4').style.display = 'block';
                    
                    UI.showToast('ุชู ุฑุจุท ุญุณุงุจู ุจูุฌุงุญ!', 'success');
                    
                    setTimeout(closeLinkAccountModal, 2000);
                }
                
            } catch (error) {
                console.error('Error verifying code:', error);
                UI.showToast(error.message, 'error');
                document.getElementById('linkLoading').style.display = 'none';
                document.getElementById('linkStep2').style.display = 'block';
            }
        }

        async function resendVerificationCode() {
            try {
                const btn = document.getElementById('linkResendBtn');
                const deliveryInfo = document.getElementById('deliveryInfo');
                if (btn) { btn.disabled = true; btn.textContent = 'โณ ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู...'; }
                
                let response, data;
                
                if (USE_FASTAPI) {
                    // ุงุณุชุฎุฏุงู FastAPI
                    response = await fetch(`${FASTAPI_TELEGRAM_URL}/telegram/resend-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ phone_number: linkedPhoneNumber })
                    });
                    data = await response.json();
                } else {
                    // ุงุณุชุฎุฏุงู Django
                    const token = localStorage.getItem('access_token');
                    response = await fetch(`${API_URL}/sections/telegram/session/resend/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ phone_number: linkedPhoneNumber })
                    });
                    data = await response.json();
                }
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู');
                }
                if (data.status === 'code_resent' && data.phone_code_hash) {
                    phoneCodeHash = data.phone_code_hash;
                    if (deliveryInfo) {
                        const current = (data.delivery || 'unknown').toString();
                        const next = (data.next_delivery || '-').toString();
                        deliveryInfo.textContent = `ุทุฑููุฉ ุงูุฅุฑุณุงู: ${current} (ุงูุชุงูู: ${next})`;
                    }
                    UI.showToast('ุชูุช ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูููุฏ', 'success');
                    startLinkTimer();
                } else {
                    UI.showToast(data.message || 'ุชูุช ุงููุนุงูุฌุฉ', 'info');
                }
            } catch (error) {
                console.error('Error resending code:', error);
                UI.showToast(error.message, 'error');
            } finally {
                const btn = document.getElementById('linkResendBtn');
                if (btn) { btn.disabled = false; btn.textContent = '๐ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูููุฏ'; }
            }
        }
        
        // ุงูุชุญูู ูู ูููุฉ ูุฑูุฑ 2FA
        async function verify2FAPassword() {
            const password = document.getElementById('link2FAPassword').value.trim();
            
            if (!password) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ', 'warning');
                return;
            }
            
            // ุฅุธูุงุฑ Loading
            document.getElementById('linkStep3').style.display = 'none';
            document.getElementById('linkLoading').style.display = 'block';
            
            try {
                let response, data;
                
                if (USE_FASTAPI) {
                    // ุงุณุชุฎุฏุงู FastAPI
                    response = await fetch(`${FASTAPI_TELEGRAM_URL}/telegram/verify-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone_number: linkedPhoneNumber,
                            password: password
                        })
                    });
                    data = await response.json();
                } else {
                    // ุงุณุชุฎุฏุงู Django
                    const token = localStorage.getItem('access_token');
                    response = await fetch(`${API_URL}/sections/telegram/session/password/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            phone_number: linkedPhoneNumber,
                            password: password
                        })
                    });
                    data = await response.json();
                }
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'ูุดู ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ');
                }
                
                if (data.status === 'success') {
                    // ูุฌุญ!
                    localStorage.setItem('telegram_phone', linkedPhoneNumber);
                    document.getElementById('linkLoading').style.display = 'none';
                    document.getElementById('linkStep4').style.display = 'block';
                    
                    UI.showToast('ุชู ุฑุจุท ุญุณุงุจู ุจูุฌุงุญ!', 'success');
                    
                    setTimeout(closeLinkAccountModal, 2000);
                }
                
            } catch (error) {
                console.error('Error verifying password:', error);
                UI.showToast(error.message, 'error');
                document.getElementById('linkLoading').style.display = 'none';
                document.getElementById('linkStep3').style.display = 'block';
            }
        }
        
        // ูุตู ุฑุจุท Telegram
        async function disconnectTelegram() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุตู ุฑุจุท ุญุณุงุจ Telegramุ\n\nุณุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุงูุฑุจุท ูุฅูุดุงุก ุงููุฑูุจุงุช.')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const phone = localStorage.getItem('telegram_phone');
                
                const response = await fetch(`${API_URL}/sections/telegram/session/disconnect/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ phone_number: phone })
                });
                
                const data = await response.json();
                
                if (!response.ok && response.status !== 404) {
                    throw new Error(data.message || data.error || 'ูุดู ูุตู ุงูุฑุจุท');
                }
                
                localStorage.removeItem('telegram_phone');
                linkedPhoneNumber = '';
                showDisconnectedState();
                UI.showToast('ุชู ูุตู ุงูุฑุจุท ุจูุฌุงุญ', 'success');
                
            } catch (error) {
                console.error('Error disconnecting:', error);
                UI.showToast(error.message, 'error');
            }
        }
        
        // ุชุญุฏูุซ ููุฎุต ุงูุฅูุดุงุก
        function updateCreationSummary() {
            const subjectName = getSubjectName();
            const subjectsText = subjectName || '-';
            
            // ุจูุงุก ุงุณู ุงูุตู
            const levelLabels = { elementary: 'ุงุจุชุฏุงุฆู', middle: 'ูุชูุณุท', high: 'ุซุงููู' };
            const gradeNumbers = ['ุงูุฃูู', 'ุงูุซุงูู', 'ุงูุซุงูุซ', 'ุงูุฑุงุจุน', 'ุงูุฎุงูุณ', 'ุงูุณุงุฏุณ'];
            const levelLabel = levelLabels[setupState.level];
            const gradeText = gradeNumbers[setupState.gradeNumber - 1] || setupState.gradeNumber;
            const gradeName = `${gradeText} ${levelLabel}`;
            
            const sectionsCount = setupState.selectedSections.length;
            const sectionsText = setupState.selectedSections.join('ุ ') || '-';
            
            document.getElementById('summaryGrade').textContent = gradeName;
            document.getElementById('summarySubject').textContent = subjectsText;
            document.getElementById('summaryCount').textContent = sectionsCount;
            document.getElementById('summarySections').textContent = sectionsText;
        }
        
        // ุฅูุดุงุก ุงููุฑูุจุงุช
        // ============================================
        // ุฏูุงู ูุนุงูุฌุฉ ุงูููุงุฏ
        // ============================================
        
        /**
         * ุงูุญุตูู ุนูู ุงุณู ุงููุงุฏุฉ ุงููุฏุฎู
         */
        function getSubjectName() {
            const subjectInput = document.getElementById('subjectName');
            return subjectInput ? subjectInput.value.trim() : '';
        }
        
        /**
         * ุชุญุฏูุซ ุนุฏุงุฏ ุงูููุงุฏ (ูู ูุนุฏ ูุณุชุฎุฏูุงู - ุชู ุงูุงุญุชูุงุธ ุจู ููุชูุงูู)
         */
        function updateSelectedSubjectsCount() {
            // ูู ูุนุฏ ููุงู ุญุงุฌุฉ ููุฐู ุงูุฏุงูุฉ ูุน ุญูู ุงููุต
            // ุชุญุฏูุซ ุงูููุฎุต
            if (linkedPhoneNumber) {
                updateCreationSummary();
            }
        }
        
        /**
         * ุญูุธ ุงูููุงุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
         */
        async function saveSubjectsToDatabase(subjects, results) {
            try {
                const token = localStorage.getItem('access_token');
                const gradeId = setupState.gradeId;
                
                // ุงุณุชุฎุฑุงุฌ IDs ุงูุดูุนุจ ุงููุงุฌุญุฉ ููุท
                const successfulSections = results
                    .filter(r => r.success)
                    .map(r => r.section);
                
                // ุงูุญุตูู ุนูู section_ids ูู setupState
                // ูุญุชุงุฌ section IDs ูู ุงูู API response ูู step 4
                const sectionIds = setupState.sectionIds || [];
                
                if (sectionIds.length === 0) {
                    console.warn('โ๏ธ ูุง ุชูุฌุฏ section IDs - ูู ูุชู ุญูุธ ุงูููุงุฏ');
                    return;
                }
                
                console.log('๐ค ุญูุธ ุงูููุงุฏ:', {
                    grade_id: gradeId,
                    section_ids: sectionIds,
                    subject_names: subjects
                });
                
                const response = await fetch(`${API_URL}/sections/subjects/assign/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        grade_id: gradeId,
                        section_ids: sectionIds,
                        subject_names: subjects
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('โ ุชู ุญูุธ ุงูููุงุฏ ุจูุฌุงุญ:', data);
                    UI.showToast(`โ ุชู ุญูุธ ${data.created} ูุงุฏุฉ ุฌุฏูุฏุฉ`, 'success', 3000);
                } else {
                    console.error('โ ูุดู ุญูุธ ุงูููุงุฏ:', data);
                    UI.showToast(`โ๏ธ ${data.error}`, 'warning');
                }
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุงุฏ:', error);
                throw error;
            }
        }
        
        // Event listener ูุญูู ุงููุงุฏุฉ
        const subjectInput = document.getElementById('subjectName');
        if (subjectInput) {
            subjectInput.addEventListener('input', () => {
                if (linkedPhoneNumber) {
                    updateCreationSummary();
                }
            });
        }
        
        document.getElementById('createGroupsBtn').addEventListener('click', createTelegramGroupsNow);
        
        async function createTelegramGroupsNow() {
            // ุงูุชุญูู ูู ุงุณู ุงููุงุฏุฉ
            const subjectName = getSubjectName();
            if (!subjectName) {
                UI.showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุงุฏุฉ', 'warning');
                document.getElementById('subjectName').focus();
                return;
            }
            
            const phone = localStorage.getItem('telegram_phone');
            if (!phone) {
                UI.showToast('ูุฑุฌู ุฑุจุท ุญุณุงุจู ุจู Telegram ุฃููุงู', 'warning');
                return;
            }
            
            // ุชุฃููุฏ
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุดุงุก ${setupState.selectedSections.length} ูุฑูุจุงุชุ`)) {
                return;
            }
            
            // ุชุนุทูู ุงูุฒุฑ
            const btn = document.getElementById('createGroupsBtn');
            const btnText = document.getElementById('createGroupsText');
            const btnSpinner = document.getElementById('createGroupsSpinner');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            
            // ุฅุธูุงุฑ Progress
            document.getElementById('creationProgress').style.display = 'block';
            document.getElementById('creationResults').style.display = 'none';
            
            try {
                // ุจูุงุก ุงุณู ุงูุตู
                console.log('๐ ุงุณู ุงููุงุฏุฉ:', subjectName); // Debug log
                const levelLabels = { elementary: 'ุงุจุชุฏุงุฆู', middle: 'ูุชูุณุท', high: 'ุซุงููู' };
                const gradeNumbers = ['ุงูุฃูู', 'ุงูุซุงูู', 'ุงูุซุงูุซ', 'ุงูุฑุงุจุน', 'ุงูุฎุงูุณ', 'ุงูุณุงุฏุณ'];
                const levelLabel = levelLabels[setupState.level];
                const gradeText = gradeNumbers[setupState.gradeNumber - 1] || setupState.gradeNumber;
                const gradeName = `${gradeText} ${levelLabel}`;
                
                const token = localStorage.getItem('access_token');
                const totalSections = setupState.selectedSections.length;
                const results = [];
                
                // ุฅูุดุงุก ูู ูุฑูุจ ุนูู ุญุฏุฉ
                for (let i = 0; i < totalSections; i++) {
                    const section = setupState.selectedSections[i];
                    
                    // ุชุญุฏูุซ Progress
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const progressCount = document.getElementById('progressCount');
                    const progress = Math.round(((i + 1) / totalSections) * 100);
                    
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    progressCount.textContent = `${i + 1}/${totalSections}`;
                    
                    try {
                        // ุงุณุชุฏุนุงุก API ููู ุดุนุจุฉ
                        const response = await fetch(`${API_URL}/sections/telegram/create-single-group/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                phone_number: phone,
                                grade_name: gradeName,
                                subject_name: subjectName,
                                school_name: setupState.schoolName || 'ุงููุฏุฑุณุฉ',
                                section: section
                            })
                        });
                        
                        const data = await response.json();
                        
                        console.log(`๐ก API Response ูุดุนุจุฉ ${section}:`, data);
                        
                        if (response.ok) {
                            results.push({
                                success: true,
                                section: section,
                                invite_link: data.invite_link || data.link || data.telegram_link,
                                link: data.link,
                                telegram_link: data.telegram_link,
                                group_link: data.group_link,
                                chat_id: data.chat_id || data.group_id,
                                group_id: data.group_id,
                                full_data: data  // ุญูุธ ุงูุจูุงูุงุช ุงููุงููุฉ ูููุญุต
                            });
                        } else {
                            results.push({
                                success: false,
                                section: section,
                                error: data.message || data.error || 'ูุดู ุงูุฅูุดุงุก'
                            });
                        }
                        
                        // ุชุฃุฎูุฑ ุจุณูุท ุจูู ุงูุทูุจุงุช (1 ุซุงููุฉ)
                        if (i < totalSections - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                    } catch (error) {
                        results.push({
                            success: false,
                            section: section,
                            error: error.message
                        });
                    }
                }
                
                console.log('๐ฆ ูุชุงุฆุฌ ุฅูุดุงุก ุงููุฑูุจุงุช:', results);
                console.log('๐ฆ ุฃูู ูุชูุฌุฉ (ูููุญุต):', results[0]);
                
                // ============================================
                // ุงุณุชุฎุฑุงุฌ ูุญูุธ ุงูุฑูุงุจุท
                // ============================================
                
                // 1. ุงุณุชุฎุฑุงุฌ ุงูุฑูุงุจุท ูู ุงููุชุงุฆุฌ
                let extractedLinks = extractLinksFromResults(results);
                
                console.log('๐ ุงูุฑูุงุจุท ุงููุณุชุฎุฑุฌุฉ:', {
                    count: extractedLinks.length,
                    with_links: extractedLinks.filter(l => l.telegram_link).length,
                    without_links: extractedLinks.filter(l => !l.telegram_link).length
                });
                
                // ============================================
                // Fallback: ุฅุฐุง ูู ูุญุตู ุนูู ุฑูุงุจุทุ ุงุญูุธ ุจุฏูู ุฑูุงุจุท
                // ุณูุชู ููุคูุง ูุงุญูุงู ูู sections-manage ุฃู ูุฏููุงู
                // ============================================
                
                if (extractedLinks.length === 0) {
                    console.warn('โ๏ธ ูู ูุชู ุงุณุชุฎุฑุงุฌ ุฃู ุฑูุงุจุท ูู API Response');
                    console.warn('๐ก ุณูุชู ุฅูุดุงุก placeholder links ููุดูุนุจ');
                    
                    // ุฅูุดุงุก placeholder ููุดูุนุจ ุงููุงุฌุญุฉ
                    extractedLinks = results
                        .filter(r => r.success)
                        .map(r => ({
                            section_name: r.section,
                            platform: 'telegram',
                            telegram_link: '',  // ูุงุฑุบ - ุณูุชู ููุคู ูุงุญูุงู
                            chat_id: r.chat_id || r.group_id,
                            needs_link: true  // ุนูุงูุฉ ุฃู ุงูุฑุงุจุท ููููุฏ
                        }));
                    
                    console.log('๐ ุชู ุฅูุดุงุก placeholders:', extractedLinks.length);
                }
                
                // 2. ุญูุธ ูู setupState (Memory)
                setupState.sectionLinks = extractedLinks;
                console.log('โ setupState: ุชู ุญูุธ ุงูุฑูุงุจุท ูู ุงูุฐุงูุฑุฉ');
                console.log('   ุนุฏุฏ ุงูุฑูุงุจุท:', setupState.sectionLinks.length);
                console.log('   ุงูุจูุงูุงุช:', setupState.sectionLinks);
                
                // 3. ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู localStorage
                if (extractedLinks.length > 0) {
                    const saved = saveLinksToLocalStorage(extractedLinks);
                    if (saved) {
                        const linksCount = extractedLinks.filter(l => l.telegram_link).length;
                        if (linksCount > 0) {
                            UI.showToast(`๐พ ุชู ุญูุธ ${linksCount} ุฑูุงุจุท`, 'info', 2000);
                        } else {
                            console.log('๐ก ุงูุฑูุงุจุท ุบูุฑ ููุฌูุฏุฉ ูู API Response');
                            console.log('๐ ุงูุญู: ุงูุฑูุงุจุท ุณุชููู ูุชุงุญุฉ ูู sections-manage ุจุนุฏ ุงูุญูุธ');
                            UI.showToast('๐พ ุชู ุญูุธ ุจูุงูุงุช ุงูุดูุนุจ', 'warning', 3000);
                        }
                    }
                } else {
                    console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุญูุธ');
                }
                
                // ============================================
                // ุญูุธ ุงููุงุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                // ============================================
                // subjectName ูุนุฑูู ูุณุจูุงู ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ
                if (subjectName && results.some(r => r.success)) {
                    try {
                        await saveSubjectsToDatabase([subjectName], results);
                    } catch (error) {
                        console.error('ุฎุทุฃ ูู ุญูุธ ุงููุงุฏุฉ:', error);
                        // ูุง ูููู ุงูุนูููุฉ - ุงูุฑูุงุจุท ุชู ุญูุธูุง ุจูุฌุงุญ
                    }
                }
                
                // ุนุฑุถ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ
                displayCreationResults(results);
                
                // ุชูุนูู ุฒุฑ ุงูุชุงูู
                document.getElementById('nextStep5').disabled = false;
                
                const successCount = results.filter(r => r.success).length;
                UI.showToast(`ุชู ุฅูุดุงุก ${successCount} ูู ${totalSections} ูุฑูุจุงุช ุจูุฌุงุญ!`, 'success');
                
            } catch (error) {
                console.error('Error creating groups:', error);
                UI.showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline-block';
                btnSpinner.style.display = 'none';
            }
        }
        
        // ุนุฑุถ ูุชุงุฆุฌ ุงูุฅูุดุงุก
        function displayCreationResults(results) {
            const resultsList = document.getElementById('resultsList');
            
            console.log('๐จ displayCreationResults - ูุนุงูุฌุฉ ุงููุชุงุฆุฌ:', results);
            
            // ุนุฑุถ ุงููุชุงุฆุฌ
            document.getElementById('creationResults').style.display = 'block';
            
            // ุจูุงุก HTML ูููุชุงุฆุฌ
            let html = '';
            results.forEach(result => {
                if (result.success) {
                    // ุงูุจุญุซ ุนู ุงูุฑุงุจุท ูู ุฃู ุญูู
                    const link = result.invite_link || result.link || result.telegram_link || result.group_link || '';
                    
                    console.log(`๐จ ุดุนุจุฉ ${result.section} - ุงูุฑุงุจุท ุงููุณุชุฎุฏู:`, link);
                    
                    html += `
                        <div class="result-item success">
                            <span class="result-text">โ ุดุนุจุฉ ${result.section}</span>
                            ${link ? `<a href="${link}" target="_blank" class="result-link">ูุชุญ ุงููุฑูุจ</a>` : '<span style="color: #f59e0b;">โ๏ธ ูุง ููุฌุฏ ุฑุงุจุท</span>'}
                        </div>
                    `;
                } else {
                    html += `
                        <div class="result-item error">
                            <span class="result-text">โ ุดุนุจุฉ ${result.section}</span>
                            <span style="color: #dc3545; font-size: 0.9rem;">${result.error}</span>
                        </div>
                    `;
                }
            });
            
            resultsList.innerHTML = html;
        }
        
        // ============================================
        // ุงูุชูุธูู ุงูุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        // ============================================
        
        /**
         * ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ ูู localStorage
         */
        function cleanupOldStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return;
            
            try {
                const data = JSON.parse(stored);
                const ageInHours = (Date.now() - data.timestamp) / 3600000;
                
                console.log('๐งน ูุญุต ุนูุฑ ุงูุจูุงูุงุช ูู localStorage:', {
                    age_hours: ageInHours.toFixed(1),
                    max_age: MAX_AGE_HOURS,
                    should_clean: ageInHours > MAX_AGE_HOURS
                });
                
                if (ageInHours > MAX_AGE_HOURS) {
                    clearPendingLinks();
                    console.log('๐งน ุชู ุญุฐู ุจูุงูุงุช ูุฏููุฉ ุชููุงุฆูุงู');
                }
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุชูุธูู ุงูุชููุงุฆู:', error);
                clearPendingLinks();
            }
        }
        
        // ุชุดุบูู ุงูุชูุธูู ุงูุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('๐ Sections Setup: ุชู ุชุญููู ุงูุตูุญุฉ');
            cleanupOldStorage();
            
            // ุนุฑุถ ูุนูููุงุช localStorage ูู Console
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    console.log('๐ฆ localStorage: ุจูุงูุงุช ูุญููุธุฉ ููุฌูุฏุฉ', {
                        grade: `${data.grade_info.level}-${data.grade_info.gradeNumber}`,
                        sections: data.sections.length,
                        links: data.links.length,
                        age: ((Date.now() - data.timestamp) / 60000).toFixed(0) + ' ุฏูููุฉ'
                    });
                } catch (e) {
                    console.error('โ localStorage: ุจูุงูุงุช ุชุงููุฉ', e);
                }
            } else {
                console.log('โน๏ธ localStorage: ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ');
            }
        });
    </script>

    <style>
        /* Sections Preview Table Styles */
        #sectionsPreviewTable {
            font-size: 14px;
        }

        #sectionsPreviewTable th {
            font-weight: 600;
            white-space: nowrap;
        }

        #sectionsPreviewTable td {
            vertical-align: middle;
        }

        #sectionsPreviewTable a {
            transition: color 0.2s;
        }

        #sectionsPreviewTable a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            #sectionsPreviewTable {
                font-size: 12px;
            }

            #sectionsPreviewTable th,
            #sectionsPreviewTable td {
                padding: 8px !important;
            }

            #sectionsPreviewTable th:first-child,
            #sectionsPreviewTable td:first-child {
                display: none;
            }

            #sectionsPreviewContainer h4 {
                font-size: 16px !important;
            }
        }

        @media (max-width: 480px) {
            #sectionsPreviewTable {
                font-size: 11px;
            }

            #sectionsPreviewTable th:nth-child(2),
            #sectionsPreviewTable td:nth-child(2) {
                display: none;
            }
        }

        /* ==================== ๐ฑ Responsive Modals ููุฌูุงูุงุช ==================== */
        
        /* Tablets (768px and below) */
        @media (max-width: 768px) {
            .modal-dialog {
                max-width: 90%;
                margin: 15px;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .modal-body {
                max-height: 60vh;
                padding: 20px !important;
            }
            
            .modal-content button {
                padding: 10px 20px !important;
                font-size: 14px;
            }
        }
        
        /* Mobile (480px and below) */
        @media (max-width: 480px) {
            /* Modal Size */
            .modal-dialog {
                max-width: 95%;
                margin: 10px;
            }
            
            /* Modal Header */
            .modal-header {
                padding: 15px !important;
            }
            
            .modal-header h3 {
                font-size: 1rem;
            }
            
            /* Modal Body */
            .modal-body {
                max-height: 55vh;
                padding: 15px !important;
                font-size: 14px;
            }
            
            /* Input Fields */
            .modal-content input[type="text"],
            .modal-content input[type="tel"] {
                padding: 10px !important;
                font-size: 16px !important; /* โ ููุน auto-zoom ุนูู iOS */
            }
            
            /* Buttons */
            .modal-content button {
                padding: 12px 16px !important;
                font-size: 14px;
                width: 100%;
            }
            
            .modal-content .btn-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content .btn-group button {
                width: 100% !important;
            }
            
            /* Telegram Code Input */
            .code-input-group {
                gap: 5px !important;
            }
            
            .code-input-group input {
                width: 40px !important;
                height: 45px !important;
                font-size: 18px !important;
            }
            
            /* Result Items */
            .result-item {
                padding: 10px 12px;
                font-size: 13px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .result-item .result-link {
                font-size: 12px;
                word-break: break-all;
            }
        }
        
        /* Extra Small (360px and below) */
        @media (max-width: 360px) {
            .modal-dialog {
                max-width: 98%;
                margin: 5px;
            }
            
            .modal-header {
                padding: 12px !important;
            }
            
            .modal-header h3 {
                font-size: 0.95rem;
            }
            
            .modal-body {
                padding: 12px !important;
                font-size: 13px;
            }
            
            .code-input-group input {
                width: 35px !important;
                height: 40px !important;
                font-size: 16px !important;
            }
        }
    </style>

    <!-- โ Dark Mode System -->
    <script src="/assets/js/dark-mode-manager.js"></script>
    <script src="/assets/js/dark-mode-init.js"></script>
</body>
</html>
