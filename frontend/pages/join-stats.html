<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… - SmartEdu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header .section-info {
            color: #666;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .stat-card.total i { color: #667eea; }
        .stat-card.joined i { color: #48bb78; }
        .stat-card.pending i { color: #ed8936; }
        .stat-card.rate i { color: #9f7aea; }

        .stat-card .value {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card.total .value { color: #667eea; }
        .stat-card.joined .value { color: #48bb78; }
        .stat-card.pending .value { color: #ed8936; }
        .stat-card.rate .value { color: #9f7aea; }

        .stat-card .label {
            color: #666;
            font-size: 16px;
        }

        .students-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 25px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .students-table th,
        .students-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }

        .students-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .students-table tr:hover {
            background: #f7fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.joined {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.pending {
            background: #fed7d7;
            color: #742a2a;
        }

        .username {
            color: #667eea;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 18px;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .students-table {
                font-size: 14px;
            }

            .students-table th,
            .students-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</h1>
            <div class="section-info" id="sectionInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div id="loadingDiv" class="loading">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p style="margin-top: 20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card total">
                    <i class="fas fa-users"></i>
                    <div class="value" id="totalStudents">0</div>
                    <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                </div>

                <div class="stat-card joined">
                    <i class="fas fa-user-check"></i>
                    <div class="value" id="joinedStudents">0</div>
                    <div class="label">Ø§Ù†Ø¶Ù…ÙˆØ§ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</div>
                </div>

                <div class="stat-card pending">
                    <i class="fas fa-user-clock"></i>
                    <div class="value" id="pendingStudents">0</div>
                    <div class="label">Ù„Ù… ÙŠÙ†Ø¶Ù…ÙˆØ§ Ø¨Ø¹Ø¯</div>
                </div>

                <div class="stat-card rate">
                    <i class="fas fa-percentage"></i>
                    <div class="value" id="joinRate">0%</div>
                    <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</div>
                </div>
            </div>

            <div class="students-section">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="filter-btn" data-filter="joined">Ø§Ù†Ø¶Ù…ÙˆØ§</button>
                    <button class="filter-btn" data-filter="pending">Ù„Ù… ÙŠÙ†Ø¶Ù…ÙˆØ§</button>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
                    </div>
                </div>

                <div id="tableContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let allStudents = [];
        let currentFilter = 'all';

        // Ø¬Ù„Ø¨ Token Ù…Ù† URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'block';
            document.getElementById('errorDiv').textContent = 'âŒ Token ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·';
        } else {
            loadStatistics();
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/sections/join-link-stats/?token=${token}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }

                // Ø¥Ø®ÙØ§Ø¡ Loading
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('contentDiv').style.display = 'block';

                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¹Ø¨Ø©
                const sectionInfo = data.section_info;
                document.getElementById('sectionInfo').innerHTML = `
                    <strong>${sectionInfo.grade}</strong> - Ø§Ù„Ø´Ø¹Ø¨Ø©: <strong>${sectionInfo.name}</strong>
                    <br>
                    ${sectionInfo.school} | Ø§Ù„Ù…Ø¹Ù„Ù…: ${sectionInfo.teacher}
                `;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const stats = data.statistics;
                document.getElementById('totalStudents').textContent = stats.total_students;
                document.getElementById('joinedStudents').textContent = stats.joined_telegram;
                document.getElementById('pendingStudents').textContent = stats.not_joined;
                document.getElementById('joinRate').textContent = `${stats.join_rate}%`;

                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                allStudents = data.students;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                renderTable();

            } catch (error) {
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('errorDiv').style.display = 'block';
                document.getElementById('errorDiv').textContent = `âŒ ${error.message}`;
            }
        }

        function renderTable() {
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
            let filteredStudents = allStudents;

            if (currentFilter === 'joined') {
                filteredStudents = allStudents.filter(s => s.joined);
            } else if (currentFilter === 'pending') {
                filteredStudents = allStudents.filter(s => !s.joined);
            }

            // Ø§Ù„Ø¨Ø­Ø«
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => 
                    s.name.toLowerCase().includes(searchTerm)
                );
            }

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            if (filteredStudents.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-inbox fa-3x" style="color: #cbd5e0;"></i>
                        <p style="margin-top: 15px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredStudents.forEach((student, index) => {
                const statusBadge = student.joined 
                    ? '<span class="status-badge joined">âœ… Ø§Ù†Ø¶Ù…</span>'
                    : '<span class="status-badge pending">â³ Ù„Ù… ÙŠÙ†Ø¶Ù…</span>';

                const username = student.username 
                    ? `<span class="username">@${student.username}</span>`
                    : '-';

                const joinedDate = student.joined_at 
                    ? new Date(student.joined_at).toLocaleString('ar-SA')
                    : '-';

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${student.name}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${username}</td>
                        <td>${joinedDate}</td>
                        <td>${student.phone || '-'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('tableContainer').innerHTML = html;
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderTable();
            });
        });

        // Search
        document.getElementById('searchInput').addEventListener('input', renderTable);

        // Refresh
        function refreshData() {
            document.getElementById('contentDiv').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'block';
            loadStatistics();
        }

        // Export to Excel (Ø¨Ø³ÙŠØ· - ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡)
        function exportToExcel() {
            let csv = 'Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…,ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n';
            
            allStudents.forEach(student => {
                csv += `${student.name},`;
                csv += `${student.joined ? 'Ø§Ù†Ø¶Ù…' : 'Ù„Ù… ÙŠÙ†Ø¶Ù…'},`;
                csv += `${student.username || '-'},`;
                csv += `${student.joined_at ? new Date(student.joined_at).toLocaleString('ar-SA') : '-'},`;
                csv += `${student.phone || '-'}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `students_stats_${token}.csv`;
            link.click();
        }
    </script>
</body>
</html>
