<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00ADEF">
    
    <title>ุฅุญุตุงุฆูุงุช ุงูุตููู - ูุดุฑูุนู ุงูุฐูู</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/dark-mode.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/mobile-responsive.css">
</head>
<body data-page-type="dashboard">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h2>๐ ุฅุญุตุงุฆูุงุช ุงูุตููู ูุงูุดูุนุจ</h2>
            </div>
            <div class="navbar-menu">
                <button class="btn btn-secondary" onclick="exportData()">๐ฅ ุชุตุฏูุฑ</button>
                <a href="/pages/sections-manage.html" class="btn btn-secondary">ุงูุนูุฏุฉ</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="sections-container">
        <!-- Overview Stats -->
        <div class="sections-header fade-in">
            <h1>๐ ูุธุฑุฉ ุนุงูุฉ</h1>
            <p>ุฅุญุตุงุฆูุงุช ุดุงููุฉ ุนู ุฌููุน ุงูุตููู ูุงูุดูุนุจ</p>
        </div>

        <!-- Main Stats Grid -->
        <div class="summary-grid slide-up">
            <div class="summary-card" style="border-right: 4px solid #00ADEF;">
                <h4>ุฅุฌูุงูู ุงูุตููู</h4>
                <div class="summary-value" id="totalGrades">0</div>
                <div class="summary-label">ุตู ุฏุฑุงุณู</div>
            </div>
            
            <div class="summary-card" style="border-right: 4px solid #4ECDC4;">
                <h4>ุฅุฌูุงูู ุงูุดูุนุจ</h4>
                <div class="summary-value" id="totalSections">0</div>
                <div class="summary-label">ุดุนุจุฉ</div>
            </div>
            
            <div class="summary-card" style="border-right: 4px solid #FFE66D;">
                <h4>ุฅุฌูุงูู ุงูุทูุงุจ</h4>
                <div class="summary-value" id="totalStudents">0</div>
                <div class="summary-label">ุทุงูุจ ูุณุฌู</div>
            </div>
            
            <div class="summary-card" style="border-right: 4px solid #28A745;">
                <h4>ูุนุฏู ุงูุดูุนุจ</h4>
                <div class="summary-value" id="avgSections">0</div>
                <div class="summary-label">ุดุนุจุฉ ููู ุตู</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="setup-form slide-up" style="margin-top: 30px;">
            <div class="form-section">
                <h3>๐ ุงูุชูุฒูุน ุญุณุจ ุงููุฑุญูุฉ</h3>
                
                <div id="levelDistribution" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                </div>
            </div>
        </div>

        <!-- Top Performing Sections -->
        <div class="setup-form slide-up" style="margin-top: 20px;">
            <div class="form-section">
                <h3>โญ ุงูุดูุนุจ ุงูุฃูุซุฑ ูุดุงุทุงู</h3>
                
                <div class="sections-table">
                    <table class="mobile-stack">
                        <thead>
                            <tr>
                                <th>ุงูุชุฑุชูุจ</th>
                                <th>ุงููุฏุฑุณุฉ</th>
                                <th>ุงูุตู</th>
                                <th>ุงูุดุนุจุฉ</th>
                                <th>ุงูุทูุงุจ</th>
                                <th>ุงูููุถููู</th>
                                <th>ุงููุณุจุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="topSectionsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loader" style="margin: 0 auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="setup-form slide-up" style="margin-top: 20px;">
            <div class="form-section">
                <h3>๐ ุงููุดุงุท ุงูุฃุฎูุฑ</h3>
                
                <div id="recentActivity">
                    <div style="text-align: center; padding: 40px;">
                        <div class="loader" style="margin: 0 auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Stats by Grade -->
        <div class="setup-form slide-up" style="margin-top: 20px;">
            <div class="form-section">
                <h3>๐ ุฅุญุตุงุฆูุงุช ุชูุตูููุฉ ููุตููู</h3>
                
                <div id="gradeDetailedStats">
                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/app.js"></script>
    <script src="/assets/js/sections-api.js"></script>

    <script>
        // State
        let dashboardData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            auth.protectPage();
            await loadDashboardData();
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await sectionsAPI.getMyGrades();
                dashboardData = response;
                
                // Update all sections
                updateOverviewStats(response.stats);
                updateLevelDistribution(response.grades);
                await updateTopSections(response.grades);
                updateRecentActivity(response.grades);
                updateGradeDetailedStats(response.grades);
                
            } catch (error) {
                UI.showToast('ูุดู ุชุญููู ุงูุจูุงูุงุช: ' + error.message, 'error');
            }
        }

        // Update overview stats
        function updateOverviewStats(stats) {
            document.getElementById('totalGrades').textContent = stats.total_grades || 0;
            document.getElementById('totalSections').textContent = stats.total_sections || 0;
            document.getElementById('totalStudents').textContent = stats.total_students || 0;
            
            const avgSections = stats.total_grades > 0 
                ? (stats.total_sections / stats.total_grades).toFixed(1)
                : 0;
            document.getElementById('avgSections').textContent = avgSections;
        }

        // Update level distribution
        function updateLevelDistribution(grades) {
            const distribution = {
                'elementary': { count: 0, label: 'ุงุจุชุฏุงุฆู', icon: '๐', color: '#FF6B6B' },
                'middle': { count: 0, label: 'ูุชูุณุท', icon: '๐', color: '#4ECDC4' },
                'high': { count: 0, label: 'ุซุงููู', icon: '๐', color: '#95E1D3' }
            };

            grades.forEach(grade => {
                if (distribution[grade.level]) {
                    distribution[grade.level].count++;
                }
            });

            const container = document.getElementById('levelDistribution');
            container.innerHTML = '';

            Object.entries(distribution).forEach(([key, data]) => {
                const percentage = grades.length > 0 
                    ? Math.round((data.count / grades.length) * 100)
                    : 0;

                const card = document.createElement('div');
                card.style.cssText = `
                    background: var(--card-bg);
                    border: 2px solid var(--border-color);
                    border-radius: 12px;
                    padding: 25px;
                    text-align: center;
                    transition: all 0.3s;
                `;

                card.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">${data.icon}</div>
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">${data.label}</h4>
                    <div style="font-size: 32px; font-weight: bold; color: ${data.color}; margin-bottom: 10px;">
                        ${data.count}
                    </div>
                    <div style="background: ${data.color}22; padding: 8px; border-radius: 20px; color: ${data.color}; font-size: 14px;">
                        ${percentage}% ูู ุงููุฌููุน
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Update top sections
        async function updateTopSections(grades) {
            const tbody = document.getElementById('topSectionsTable');
            tbody.innerHTML = '';

            // ุฌูุน ุฌููุน ุงูุดูุนุจ
            let allSections = [];
            
            for (const grade of grades) {
                try {
                    const response = await sectionsAPI.getGradeSections(grade.id);
                    response.sections.forEach(section => {
                        const joinRate = section.registrations_count > 0
                            ? (section.joined_count / section.registrations_count) * 100
                            : 0;
                        
                        allSections.push({
                            school: grade.school_name,
                            grade: grade.display_name,
                            section: section.section_name,
                            students: section.total_students,
                            joined: section.joined_count || 0,
                            rate: joinRate
                        });
                    });
                } catch (error) {
                    console.error('Error loading sections:', error);
                }
            }

            // ุชุฑุชูุจ ุญุณุจ ุงููุณุจุฉ
            allSections.sort((a, b) => b.rate - a.rate);
            
            // ุนุฑุถ ุฃูุถู 10
            const topSections = allSections.slice(0, 10);

            if (topSections.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            ูุง ุชูุฌุฏ ุดูุนุจ ุจุนุฏ
                        </td>
                    </tr>
                `;
                return;
            }

            topSections.forEach((section, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center;">
                        <span style="display: inline-block; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; background: ${getRankColor(index)}; color: white; font-weight: bold;">
                            ${index + 1}
                        </span>
                    </td>
                    <td>${section.school}</td>
                    <td>${section.grade}</td>
                    <td>${section.section}</td>
                    <td style="text-align: center;">${section.students}</td>
                    <td style="text-align: center;">${section.joined}</td>
                    <td style="text-align: center;">
                        <span style="padding: 5px 15px; background: ${getProgressColor(section.rate)}22; color: ${getProgressColor(section.rate)}; border-radius: 20px; font-weight: bold;">
                            ${section.rate.toFixed(1)}%
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update recent activity
        function updateRecentActivity(grades) {
            const container = document.getElementById('recentActivity');
            
            if (grades.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        ูุง ุชูุฌุฏ ุฃูุดุทุฉ ุญุฏูุซุฉ
                    </div>
                `;
                return;
            }

            // ุชุฑุชูุจ ุญุณุจ ุชุงุฑูุฎ ุงูุฅูุดุงุก
            const sortedGrades = [...grades].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

            sortedGrades.slice(0, 5).forEach(grade => {
                const timeAgo = getTimeAgo(grade.created_at);
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-color); border-radius: 10px; border-right: 4px solid var(--primary-color);">
                        <div style="font-size: 32px;">๐</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                                ุชู ุฅูุดุงุก ุตู ุฌุฏูุฏ
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${grade.school_name} - ${grade.display_name}
                            </div>
                        </div>
                        <div style="text-align: left; color: var(--text-secondary); font-size: 12px;">
                            ${timeAgo}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Update grade detailed stats
        function updateGradeDetailedStats(grades) {
            const container = document.getElementById('gradeDetailedStats');
            
            if (grades.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        ูุง ุชูุฌุฏ ุจูุงูุงุช
                    </div>
                `;
                return;
            }

            let html = '';

            grades.forEach(grade => {
                html += `
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            ${grade.school_name} - ${grade.display_name}
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                                    ${grade.sections_count || 0}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">ุนุฏุฏ ุงูุดูุนุจ</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: ${grade.is_active ? 'var(--success-color)' : 'var(--danger-color)'};">
                                    ${grade.is_active ? 'ูุดุท' : 'ุบูุฑ ูุดุท'}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">ุงูุญุงูุฉ</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                                <div style="font-size: 14px; font-weight: bold; color: var(--text-primary);">
                                    ${formatDate(grade.created_at)}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">ุชุงุฑูุฎ ุงูุฅูุดุงุก</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Export data
        function exportData() {
            if (!dashboardData) {
                UI.showToast('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ', 'warning');
                return;
            }

            const csvContent = generateCSV(dashboardData);
            downloadCSV(csvContent, 'sections_report.csv');
            UI.showToast('โ ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช', 'success');
        }

        // Generate CSV
        function generateCSV(data) {
            let csv = 'ุงููุฏุฑุณุฉ,ุงููุฑุญูุฉ,ุงูุตู,ุนุฏุฏ ุงูุดูุนุจ,ุงูุญุงูุฉ,ุชุงุฑูุฎ ุงูุฅูุดุงุก\n';
            
            data.grades.forEach(grade => {
                csv += `"${grade.school_name}","${grade.level_display}","${grade.grade_number}","${grade.sections_count}","${grade.is_active ? 'ูุดุท' : 'ุบูุฑ ูุดุท'}","${formatDate(grade.created_at)}"\n`;
            });
            
            return csv;
        }

        // Download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Helper functions
        function getRankColor(index) {
            const colors = ['#FFD700', '#C0C0C0', '#CD7F32', '#00ADEF', '#4ECDC4'];
            return colors[index] || '#95E1D3';
        }

        function getProgressColor(rate) {
            if (rate >= 80) return '#28A745';
            if (rate >= 60) return '#FFE66D';
            if (rate >= 40) return '#FFC107';
            return '#DC3545';
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `ูุจู ${days} ${days === 1 ? 'ููู' : 'ุฃูุงู'}`;
            if (hours > 0) return `ูุจู ${hours} ${hours === 1 ? 'ุณุงุนุฉ' : 'ุณุงุนุงุช'}`;
            if (minutes > 0) return `ูุจู ${minutes} ${minutes === 1 ? 'ุฏูููุฉ' : 'ุฏูุงุฆู'}`;
            return 'ุงูุขู';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>

    <style>
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 173, 239, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- โ Dark Mode System -->
    <script src="/assets/js/dark-mode-manager.js"></script>
    <script src="/assets/js/dark-mode-init.js"></script>
</body>
</html>
