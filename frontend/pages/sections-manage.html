<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00ADEF">
    
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´ÙØ¹Ø¨ - Ù…Ø´Ø±ÙˆØ¹ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/dark-mode.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/mobile-responsive.css">
</head>
<body data-page-type="dashboard">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h2>ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´ÙØ¹Ø¨</h2>
            </div>
            <div class="navbar-menu">
                <a href="/pages/sections-setup.html" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</a>
                <a href="/pages/dashboard.html" class="btn btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="sections-container">
        <!-- Stats Cards -->
        <div class="summary-grid fade-in" id="statsCards">
            <div class="summary-card">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ</h4>
                <div class="summary-value" id="totalGrades">0</div>
                <div class="summary-label">ØµÙ Ø¯Ø±Ø§Ø³ÙŠ</div>
            </div>
            <div class="summary-card">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙØ¹Ø¨</h4>
                <div class="summary-value" id="totalSections">0</div>
                <div class="summary-label">Ø´Ø¹Ø¨Ø©</div>
            </div>
            <div class="summary-card">
                <h4>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h4>
                <div class="summary-value" id="totalStudents">0</div>
                <div class="summary-label">Ø·Ø§Ù„Ø¨</div>
            </div>
            <div class="summary-card">
                <h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h4>
                <div class="summary-value" id="joinRate">0%</div>
                <div class="summary-label">Ù„Ù„Ù‚Ø±ÙˆØ¨Ø§Øª</div>
            </div>
        </div>

        <!-- Grades List -->
        <div class="setup-form slide-up" style="margin-top: 30px;">
            <div class="form-section">
                <h3>ğŸ“š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
                
                <div id="gradesList">
                    <!-- Loading -->
                    <div id="loadingGrades" style="text-align: center; padding: 40px;">
                        <div class="loader" style="margin: 0 auto;"></div>
                        <p style="color: var(--text-secondary); margin-top: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ“š</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ø¨Ø¹Ø¯</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 30px;">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¯Ø±Ø§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯</p>
                        <a href="/pages/sections-setup.html" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</a>
                    </div>

                    <!-- Grades Container -->
                    <div id="gradesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Detail Modal -->
    <div id="sectionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¹Ø¨Ø©</h3>
                <button class="modal-close" onclick="closeSectionModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- Students List Modal -->
    <div id="studentsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="studentsModalTitle">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <button class="modal-close" onclick="closeStudentsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- Statistics -->
                <div id="studentsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>
                
                <!-- Search and Filter -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="studentSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." 
                           style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 14px;"
                           onkeyup="filterStudents()">
                    <select id="filterStatus" onchange="filterStudents()" 
                            style="padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 14px;">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="joined">Ø§Ù†Ø¶Ù…ÙˆØ§</option>
                        <option value="not-joined">Ù„Ù… ÙŠÙ†Ø¶Ù…ÙˆØ§</option>
                    </select>
                    <select id="sortOrder" onchange="sortStudents()" 
                            style="padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 14px;">
                        <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                        <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
                        <option value="name">Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹</option>
                    </select>
                </div>

                <!-- Students List -->
                <div id="studentsListContainer" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Create Telegram Groups Modal -->
    <div id="telegramGroupsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="telegramModalTitle">ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h3>
                <button class="modal-close" onclick="closeTelegramGroupsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Phone Number Input -->
                <div id="telegramStep1" style="display: block;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">ğŸ“±</div>
                        <h3 style="margin-bottom: 10px; color: var(--primary-color);">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h3>
                        <p id="gradeInfoDisplay" style="font-weight: bold; font-size: 18px; margin-bottom: 5px;"></p>
                        <p id="sectionsCountDisplay" style="color: var(--text-secondary);"></p>
                    </div>

                    <div style="background: var(--card-bg); padding: 25px; border-radius: 15px; border: 2px solid var(--primary-color); margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 16px; color: var(--primary-color);">
                            ğŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:
                        </label>
                        <input type="tel" id="telegramPhoneInput" 
                               placeholder="Ù…Ø«Ø§Ù„: +966544711074" 
                               style="width: 100%; padding: 18px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 18px; text-align: center; font-weight: bold;"
                               value=""
                               autofocus>
                        <small style="display: block; margin-top: 12px; color: var(--text-secondary); text-align: center;">
                            â„¹ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ + Ù…ØªØ¨ÙˆØ¹Ø§Ù‹ Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©
                        </small>
                    </div>

                    <div style="background: var(--warning-bg); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h5 style="margin-bottom: 12px; color: var(--warning-color);">âš ï¸ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù†:</h5>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">âœ…</span>
                                <span>Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">âœ…</span>
                                <span>Telegram Desktop Ù…ÙØªÙˆØ­ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">âœ…</span>
                                <span>Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª Ù…Ø³ØªÙ‚Ø±</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeTelegramGroupsModal()" style="min-width: 120px;">
                            âŒ Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button class="btn btn-primary" onclick="confirmCreateGroups()" style="min-width: 180px; font-size: 16px;">
                            âœ… Ù…ØªØ§Ø¨Ø¹Ø©
                        </button>
                    </div>
                </div>

                <!-- Step 2: Confirmation -->
                <div id="telegramStep2" style="display: none;">
                    <div style="background: var(--success-bg); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px;">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ£ÙƒÙŠØ¯</h4>
                        <p style="margin-bottom: 10px;">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                        <div id="groupsListPreview" style="max-height: 200px; overflow-y: auto; padding: 15px; background: var(--card-bg); border-radius: 8px;"></div>
                    </div>

                    <div style="background: var(--info-bg); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                        <h5 style="margin-bottom: 10px;">âœ¨ Ø³ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:</h5>
                        <ul style="margin: 0; padding-right: 20px;">
                            <li>âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª</li>
                            <li>âœ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Supergroup</li>
                            <li>âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆØª @SmartEduProjectBot</li>
                            <li>âœ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</li>
                            <li>âœ… ØªØ·Ø¨ÙŠÙ‚ ØµÙ„Ø§Ø­ÙŠØ§Øª read-only</li>
                        </ul>
                    </div>

                    <div style="background: var(--warning-bg); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                        <h5>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</h5>
                        <p style="margin: 5px 0;">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³ØªØ­ØªØ§Ø¬ Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙˆØª ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø³Ù†Ø´Ø±Ø­ Ù„Ùƒ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©)</p>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="backToStep1()">
                            â† Ø±Ø¬ÙˆØ¹
                        </button>
                        <button class="btn btn-primary" id="createGroupsBtn" onclick="startCreatingGroups()">
                            ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¢Ù†
                        </button>
                    </div>
                </div>

                <!-- Step 3: Progress -->
                <div id="telegramStep3" style="display: none;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="loader" style="margin: 0 auto 20px;"></div>
                        <h4>â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª...</h4>
                        <p style="color: var(--text-secondary); margin-top: 10px;">Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...</p>
                        <div id="progressInfo" style="margin-top: 20px; font-size: 14px;"></div>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="telegramStep4" style="display: none;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div id="resultsIcon" style="font-size: 60px; margin-bottom: 15px;">ğŸ‰</div>
                        <h3 id="resultsTitle" style="color: var(--success-color); margin-bottom: 10px;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!</h3>
                        <p id="resultsMessage" style="color: var(--text-secondary);"></p>
                    </div>

                    <div id="groupsResults" style="max-height: 300px; overflow-y: auto; margin-bottom: 25px;"></div>

                    <div style="background: var(--warning-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px;">âš ï¸ Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø© Ù…ØªØ¨Ù‚ÙŠØ©:</h5>
                        <p style="margin: 5px 0;">ÙŠØ¬Ø¨ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙˆØª Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ± ÙÙŠ ÙƒÙ„ Ù‚Ø±ÙˆØ¨</p>
                        <button class="btn btn-primary" onclick="showBotUpgradeGuide()" style="margin-top: 10px;">
                            ğŸ“– Ø´Ø±Ø­ Ø§Ù„ØªØ±Ù‚ÙŠØ©
                        </button>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-secondary" onclick="closeTelegramGroupsModal()">
                            Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- âœ… Config must load FIRST -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/app.js"></script>
    <script src="/assets/js/sections-api.js"></script>

    <script>
        // State
        let gradesData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            auth.protectPage();
            await loadGrades();
        });

        // Load grades
        async function loadGrades() {
            try {
                const response = await sectionsAPI.getMyGrades();
                gradesData = response.grades;
                
                // Update stats
                updateStats(response.stats);
                
                // Show grades or empty state
                if (gradesData.length === 0) {
                    document.getElementById('loadingGrades').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    renderGrades();
                }
            } catch (error) {
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
                document.getElementById('loadingGrades').innerHTML = `
                    <p style="color: var(--danger-color);">âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>
                    <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                `;
            }
        }

        // Update stats
        function updateStats(stats) {
            document.getElementById('totalGrades').textContent = stats.total_grades || 0;
            document.getElementById('totalSections').textContent = stats.total_sections || 0;
            document.getElementById('totalStudents').textContent = stats.total_students || 0;
            
            // Calculate join rate (placeholder - ÙŠØ­ØªØ§Ø¬ API)
            document.getElementById('joinRate').textContent = '85%';
        }

        // Render grades
        function renderGrades() {
            document.getElementById('loadingGrades').style.display = 'none';
            const container = document.getElementById('gradesContainer');
            container.innerHTML = '';

            gradesData.forEach((grade, index) => {
                const card = createGradeCard(grade, index);
                container.appendChild(card);
            });
        }

        // Create grade card
        function createGradeCard(grade, index) {
            const div = document.createElement('div');
            div.className = 'grade-card stagger-item';
            div.style.animationDelay = `${index * 0.1}s`;
            
            const levelIcons = {
                'elementary': 'ğŸ“–',
                'middle': 'ğŸ“˜',
                'high': 'ğŸ“'
            };

            div.innerHTML = `
                <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 15px; padding: 25px; margin-bottom: 20px; transition: all 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <span style="font-size: 48px;">${levelIcons[grade.level] || 'ğŸ“š'}</span>
                                <div>
                                    <h3 style="color: var(--primary-color); margin-bottom: 5px;">
                                        ${grade.school_name}
                                    </h3>
                                    <p style="color: var(--text-secondary); font-size: 16px;">
                                        ${grade.level_display} - Ø§Ù„ØµÙ ${grade.grade_number}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-icon" onclick="viewGradeSections(${grade.id})" title="Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙØ¹Ø¨">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶
                            </button>
                            <button class="btn" style="background: #0088cc; color: white;" onclick="openCreateTelegramGroupsModal(${grade.id}, '${grade.display_name}', '${grade.school_name}')" title="Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…">
                                ğŸ“± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                            </button>
                            <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="openJoinLinkModal()" title="Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨">
                                ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="editGrade(${grade.id})" title="ØªØ¹Ø¯ÙŠÙ„">
                                âœï¸
                            </button>
                            <button class="btn" style="background: var(--danger-color); color: white;" onclick="deleteGrade(${grade.id})" title="Ø­Ø°Ù">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                                ${grade.sections_count || 0}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Ø§Ù„Ø´ÙØ¹Ø¨</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--success-color);">
                                ${grade.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; font-weight: bold; color: var(--text-secondary);">
                                ${formatDate(grade.created_at)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // View grade sections
        async function viewGradeSections(gradeId) {
            try {
                const response = await sectionsAPI.getGradeSections(gradeId);
                showSectionsModal(response);
            } catch (error) {
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙØ¹Ø¨: ' + error.message, 'error');
            }
        }

        // Show sections modal
        function showSectionsModal(data) {
            const modal = document.getElementById('sectionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `Ø´ÙØ¹Ø¨ ${data.grade.display_name}`;

            let html = '<div style="max-height: 500px; overflow-y: auto;">';

            if (data.sections.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">ğŸ“­</div>
                        <p style="color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙØ¹Ø¨</p>
                    </div>
                `;
            } else {
                data.sections.forEach(section => {
                    const hasLink = section.link && section.link.join_link;
                    const joinRate = section.joined_count && section.registrations_count 
                        ? Math.round((section.joined_count / section.registrations_count) * 100)
                        : 0;

                    html += `
                        <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: var(--primary-color); margin: 0;">
                                    ${section.section_name}
                                </h4>
                                <span style="padding: 5px 15px; background: rgba(0, 173, 239, 0.1); color: var(--primary-color); border-radius: 20px; font-size: 12px;">
                                    ${section.total_students} Ø·Ø§Ù„Ø¨
                                </span>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: var(--bg-color); border-radius: 8px;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--text-primary);">
                                        ${section.registrations_count || 0}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--bg-color); border-radius: 8px;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success-color);">
                                        ${section.joined_count || 0}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Ø§Ù„Ù…Ù†Ø¶Ù…ÙˆÙ†</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--bg-color); border-radius: 8px;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--primary-color);">
                                        ${joinRate}%
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                                </div>
                            </div>

                            ${hasLink ? `
                                <div style="background: rgba(0, 173, 239, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                        Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" value="${section.link.join_link}" 
                                               style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px;" 
                                               readonly onclick="this.select()">
                                        <button class="btn btn-primary" onclick="copyLink('${section.link.join_link}')" style="padding: 8px 15px;">
                                            ğŸ“‹ Ù†Ø³Ø®
                                        </button>
                                    </div>
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn btn-primary" onclick="viewStudentsList(${section.id})" style="flex: 1;">
                                    ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨ (${section.registrations_count || 0})
                                </button>
                                ${hasLink ? `
                                    <button class="btn btn-secondary" onclick="viewLinkStats(${section.id})" style="flex: 1;">
                                        ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            modalBody.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Close modal
        function closeSectionModal() {
            document.getElementById('sectionModal').style.display = 'none';
        }

        // Copy link
        async function copyLink(link) {
            try {
                await sectionsAPI.copyToClipboard(link);
                UI.showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'success', 2000);
            } catch (error) {
                UI.showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
            }
        }

        // View section detail
        async function viewSectionDetail(sectionId) {
            try {
                const response = await sectionsAPI.getSectionDetail(sectionId);
                alert('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¹Ø¨Ø©:\n' + JSON.stringify(response.section, null, 2));
            } catch (error) {
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ' + error.message, 'error');
            }
        }

        // View link stats
        async function viewLinkStats(sectionId) {
            try {
                const stats = await sectionsAPI.getSectionLinkStats(sectionId);
                alert('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø§Ø¨Ø·:\n' + 
                      `Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: ${stats.views}\n` +
                      `Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…Ø§Øª: ${stats.joins}\n` +
                      `Ø§Ù„Ù†Ø³Ø¨Ø©: ${stats.join_rate}%`);
            } catch (error) {
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + error.message, 'error');
            }
        }

        // Edit grade
        function editGrade(gradeId) {
            const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
            if (newName) {
                sectionsAPI.updateGrade(gradeId, { school_name: newName })
                    .then(() => {
                        UI.showToast('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
                        loadGrades();
                    })
                    .catch(error => UI.showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message, 'error'));
            }
        }

        // Delete grade
        function deleteGrade(gradeId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ ÙˆØ¬Ù…ÙŠØ¹ Ø´ÙØ¹Ø¨Ù‡ØŸ')) {
                sectionsAPI.deleteGrade(gradeId)
                    .then(() => {
                        UI.showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                        loadGrades();
                    })
                    .catch(error => UI.showToast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + error.message, 'error'));
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('sectionModal');
            const studentsModal = document.getElementById('studentsModal');
            if (event.target === modal) {
                closeSectionModal();
            }
            if (event.target === studentsModal) {
                closeStudentsModal();
            }
        }

        // ==================== Students List Functions ====================
        
        let currentStudentsData = null;
        let filteredStudents = [];

        // View students list
        async function viewStudentsList(sectionId) {
            try {
                const response = await sectionsAPI.getSectionStudents(sectionId);
                currentStudentsData = response;
                filteredStudents = [...response.students];
                
                showStudentsModal(response);
            } catch (error) {
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨: ' + error.message, 'error');
            }
        }

        // Show students modal
        function showStudentsModal(data) {
            const modal = document.getElementById('studentsModal');
            const title = document.getElementById('studentsModalTitle');
            
            title.textContent = `ğŸ‘¥ Ø·Ù„Ø§Ø¨ ${data.section.name} - ${data.section.grade}`;
            
            // Display statistics
            renderStudentsStats(data.statistics);
            
            // Display students list
            renderStudentsList(filteredStudents);
            
            // Reset filters
            document.getElementById('studentSearch').value = '';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('sortOrder').value = 'newest';
            
            modal.style.display = 'flex';
        }

        // Render students statistics
        function renderStudentsStats(stats) {
            const container = document.getElementById('studentsStats');
            container.innerHTML = `
                <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 10px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--primary-color);">
                        ${stats.total_registered}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div>
                </div>
                <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 10px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--success-color);">
                        ${stats.joined_group}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Ø§Ù†Ø¶Ù…ÙˆØ§ Ù„Ù„Ù‚Ø±ÙˆØ¨</div>
                </div>
                <div style="text-align: center; padding: 15px; background: var(--bg-color); border-radius: 10px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--warning-color);">
                        ${stats.not_joined}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Ù„Ù… ÙŠÙ†Ø¶Ù…ÙˆØ§ Ø¨Ø¹Ø¯</div>
                </div>
            `;
        }

        // Render students list
        function renderStudentsList(students) {
            const container = document.getElementById('studentsListContainer');
            
            if (!students || students.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">ğŸ‘¥</div>
                        <p style="color: var(--text-secondary);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>
                    </div>
                `;
                return;
            }

            let html = '';
            students.forEach(student => {
                const statusIcon = student.joined_group ? 'âœ…' : 'â³';
                const statusText = student.joined_group ? 'Ø§Ù†Ø¶Ù… Ù„Ù„Ù‚Ø±ÙˆØ¨' : 'Ù„Ù… ÙŠÙ†Ø¶Ù… Ø¨Ø¹Ø¯';
                const statusColor = student.joined_group ? 'var(--success-color)' : 'var(--warning-color)';
                
                const registeredDate = new Date(student.registered_at).toLocaleString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 12px; transition: all 0.3s;" 
                         onmouseover="this.style.borderColor='var(--primary-color)'" 
                         onmouseout="this.style.borderColor='var(--border-color)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-weight: bold; color: var(--text-secondary); font-size: 14px;">
                                        #${student.number}
                                    </span>
                                    <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                        ${student.full_name}
                                    </span>
                                </div>
                                
                                <div style="display: flex; gap: 15px; font-size: 13px; color: var(--text-secondary);">
                                    <span>${statusIcon} <span style="color: ${statusColor};">${statusText}</span></span>
                                    <span>ğŸ“… ${registeredDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Filter students
        function filterStudents() {
            if (!currentStudentsData) return;

            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            filteredStudents = currentStudentsData.students.filter(student => {
                // Search filter
                const matchesSearch = student.full_name.toLowerCase().includes(searchTerm);
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'joined') {
                    matchesStatus = student.joined_group === true;
                } else if (statusFilter === 'not-joined') {
                    matchesStatus = student.joined_group === false;
                }

                return matchesSearch && matchesStatus;
            });

            sortStudents();
        }

        // Sort students
        function sortStudents() {
            const sortOrder = document.getElementById('sortOrder').value;

            if (sortOrder === 'newest') {
                filteredStudents.sort((a, b) => new Date(b.registered_at) - new Date(a.registered_at));
            } else if (sortOrder === 'oldest') {
                filteredStudents.sort((a, b) => new Date(a.registered_at) - new Date(b.registered_at));
            } else if (sortOrder === 'name') {
                filteredStudents.sort((a, b) => a.full_name.localeCompare(b.full_name, 'ar'));
            }

            renderStudentsList(filteredStudents);
        }

        // Close students modal
        function closeStudentsModal() {
            document.getElementById('studentsModal').style.display = 'none';
            currentStudentsData = null;
            filteredStudents = [];
        }

        // Export to Excel
        async function exportToExcel() {
            if (!filteredStudents || filteredStudents.length === 0) {
                UI.showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }

            // Create CSV content
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += 'Ø§Ù„Ø±Ù‚Ù…,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø­Ø§Ù„Ø©,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n';
            
            filteredStudents.forEach(student => {
                const status = student.joined_group ? 'Ø§Ù†Ø¶Ù…' : 'Ù„Ù… ÙŠÙ†Ø¶Ù…';
                const date = new Date(student.registered_at).toLocaleDateString('ar-SA');
                csvContent += `${student.number},"${student.full_name}",${status},${date}\n`;
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `students_${currentStudentsData.section.name}_${Date.now()}.csv`;
            link.click();

            UI.showToast('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Export to CSV
        function exportToCSV() {
            exportToExcel(); // Same implementation
        }

        // Copy students list
        async function copyStudentsList() {
            if (!filteredStudents || filteredStudents.length === 0) {
                UI.showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„Ù†Ø³Ø®', 'warning');
                return;
            }

            let text = `Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨ ${currentStudentsData.section.name}\n`;
            text += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${filteredStudents.length} Ø·Ø§Ù„Ø¨\n\n`;
            
            filteredStudents.forEach(student => {
                const status = student.joined_group ? 'âœ…' : 'â³';
                text += `${student.number}. ${student.full_name} ${status}\n`;
            });

            try {
                await navigator.clipboard.writeText(text);
                UI.showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
            } catch (error) {
                UI.showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
            }
        }

        // ==================== Telegram Groups Modal Functions ====================
        
        let currentGradeForTelegram = null;
        let currentGradeData = null;

        function openCreateTelegramGroupsModal(gradeId, gradeName, schoolName) {
            currentGradeForTelegram = gradeId;
            currentGradeData = { gradeName, schoolName };
            
            // Reset modal to step 1
            document.getElementById('telegramStep1').style.display = 'block';
            document.getElementById('telegramStep2').style.display = 'none';
            document.getElementById('telegramStep3').style.display = 'none';
            document.getElementById('telegramStep4').style.display = 'none';
            
            // Update info
            document.getElementById('gradeInfoDisplay').textContent = `${gradeName} - ${schoolName}`;
            
            // Get sections count
            const grade = gradesData.find(g => g.id === gradeId);
            if (grade) {
                document.getElementById('sectionsCountDisplay').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙØ¹Ø¨: ${grade.sections_count}`;
            }
            
            // Show modal
            const modal = document.getElementById('telegramGroupsModal');
            modal.style.display = 'flex';
        }

        function closeTelegramGroupsModal() {
            document.getElementById('telegramGroupsModal').style.display = 'none';
            currentGradeForTelegram = null;
            currentGradeData = null;
        }

        function confirmCreateGroups() {
            const phoneNumber = document.getElementById('telegramPhoneInput').value.trim();
            
            if (!phoneNumber) {
                UI.showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'warning');
                return;
            }
            
            if (!phoneNumber.startsWith('+')) {
                UI.showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ +', 'warning');
                return;
            }
            
            // Preview groups list
            const grade = gradesData.find(g => g.id === currentGradeForTelegram);
            if (grade && grade.sections_count > 0) {
                let html = '';
                const arabicLetters = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯', 'Ù‡', 'Ùˆ', 'Ø²', 'Ø­', 'Ø·', 'ÙŠ'];
                for (let i = 0; i < grade.sections_count; i++) {
                    html += `<div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                        ğŸ“± ${currentGradeData.gradeName} ${arabicLetters[i]} - ${currentGradeData.schoolName}
                    </div>`;
                }
                document.getElementById('groupsListPreview').innerHTML = html;
            }
            
            // Move to step 2
            document.getElementById('telegramStep1').style.display = 'none';
            document.getElementById('telegramStep2').style.display = 'block';
        }

        function backToStep1() {
            document.getElementById('telegramStep2').style.display = 'none';
            document.getElementById('telegramStep1').style.display = 'block';
        }

        async function startCreatingGroups() {
            const phoneNumber = document.getElementById('telegramPhoneInput').value.trim();
            
            // Move to step 3 (progress)
            document.getElementById('telegramStep2').style.display = 'none';
            document.getElementById('telegramStep3').style.display = 'block';
            
            document.getElementById('progressInfo').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø®Ø§Ø¯Ù…...';
            
            try {
                // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ token Ù…Ù† localStorage
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                const response = await fetch(`${API.baseURL}/sections/grade/${currentGradeForTelegram}/create-telegram-groups/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ phone_number: phoneNumber })
                });
                
                const data = await response.json();
                
                // Move to step 4 (results)
                document.getElementById('telegramStep3').style.display = 'none';
                document.getElementById('telegramStep4').style.display = 'block';
                
                if (data.success) {
                    document.getElementById('resultsIcon').textContent = 'ğŸ‰';
                    document.getElementById('resultsTitle').textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!';
                    document.getElementById('resultsTitle').style.color = 'var(--success-color)';
                    document.getElementById('resultsMessage').textContent = data.message;
                    
                    // Display results
                    let html = '';
                    data.results.forEach(result => {
                        if (result.success) {
                            html += `
                                <div style="background: var(--success-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <h5 style="margin-bottom: 5px;">âœ… ${result.group_name}</h5>
                                            <a href="${result.invite_link}" target="_blank" style="color: var(--primary-color); word-break: break-all;">
                                                ${result.invite_link}
                                            </a>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${result.invite_link}')" style="margin-right: 10px;">
                                            ğŸ“‹ Ù†Ø³Ø®
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div style="background: var(--danger-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                    <h5 style="margin-bottom: 5px;">âŒ ${result.section_name}</h5>
                                    <p style="color: var(--text-secondary); font-size: 14px;">${result.error || result.message}</p>
                                </div>
                            `;
                        }
                    });
                    document.getElementById('groupsResults').innerHTML = html;
                    
                    // Reload grades to show telegram button state
                    await loadGrades();
                } else {
                    document.getElementById('resultsIcon').textContent = 'âŒ';
                    document.getElementById('resultsTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£!';
                    document.getElementById('resultsTitle').style.color = 'var(--danger-color)';
                    document.getElementById('resultsMessage').textContent = data.error || data.message;
                    document.getElementById('groupsResults').innerHTML = '';
                }
                
            } catch (error) {
                console.error('Error creating telegram groups:', error);
                document.getElementById('telegramStep3').style.display = 'none';
                document.getElementById('telegramStep4').style.display = 'block';
                
                document.getElementById('resultsIcon').textContent = 'âŒ';
                document.getElementById('resultsTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£!';
                document.getElementById('resultsTitle').style.color = 'var(--danger-color)';
                document.getElementById('resultsMessage').textContent = error.message;
                document.getElementById('groupsResults').innerHTML = '';
            }
        }

        function showBotUpgradeGuide() {
            alert(`ğŸ“– ÙƒÙŠÙÙŠØ© ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙˆØª Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ±:

1. Ø§ÙØªØ­ Ø§Ù„Ù‚Ø±ÙˆØ¨ ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
2. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙˆØ¨ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
3. Ø§Ø¨Ø­Ø« Ø¹Ù† @SmartEduProjectBot
4. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª
5. Ø§Ø¶ØºØ· "Edit Admin Rights" Ø£Ùˆ "ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±"
6. ÙØ¹Ù‘Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
7. Ø§Ø¶ØºØ· "Save" Ø£Ùˆ "Ø­ÙØ¸"

ÙƒØ±Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª`);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                UI.showToast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
            } catch (error) {
                UI.showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
            }
        }
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: slideUp 0.3s;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            font-size: 32px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
        }

        .modal-body {
            padding: 25px;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 173, 239, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .stagger-item {
            animation: slideUp 0.5s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }
    </style>

    <!-- Join Link Modal -->
    <div id="joinLinkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ğŸ”— Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <button class="close-btn" onclick="closeJoinLinkModal()">&times;</button>
            </div>
            
            <div class="modal-body" style="padding: 30px;">
                <div style="margin-bottom: 25px;">
                    <p style="color: var(--text-secondary); margin-bottom: 15px; text-align: center;">
                        Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©
                    </p>
                    
                    <div style="display: flex; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 12px; border: 2px solid var(--border-color);">
                        <input 
                            type="text" 
                            id="joinLinkInput" 
                            readonly 
                            style="flex: 1; background: transparent; border: none; color: var(--primary-color); font-size: 14px; font-weight: 600; outline: none; cursor: pointer;"
                            onclick="this.select()"
                        >
                        <button 
                            class="btn btn-sm" 
                            style="background: var(--primary-color); color: white; padding: 8px 16px; white-space: nowrap;"
                            onclick="copyJoinLinkToClipboard()"
                            title="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·">
                            ğŸ“‹ Ù†Ø³Ø®
                        </button>
                    </div>
                </div>

                <!-- ğŸ” Password Protection Section -->
                <div id="passwordSection" style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px dashed rgba(255, 193, 7, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;">
                            <input type="checkbox" id="enablePassword" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: var(--text-primary);">ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</span>
                        </label>
                        <span id="passwordStatus" style="font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(108, 117, 125, 0.2); color: var(--text-secondary);">
                            ØºÙŠØ± Ù…Ø­Ù…ÙŠ
                        </span>
                    </div>
                    
                    <div id="passwordInputGroup" style="display: none;">
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <input 
                                type="text" 
                                id="linkPassword" 
                                placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ù…Ø«Ø§Ù„: Ù…Ø¯Ø±Ø³ØªÙŠ2025)" 
                                style="flex: 1; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-primary); font-size: 14px;"
                                maxlength="50"
                            >
                            <button 
                                class="btn" 
                                style="background: var(--primary-color); color: white; padding: 12px 24px; white-space: nowrap; font-weight: 600;"
                                onclick="updateJoinLinkPassword()"
                                title="ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª">
                                ğŸ’¾ ØªØ·Ø¨ÙŠÙ‚
                            </button>
                        </div>
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px; border-right: 3px solid #ffc107;">
                            <p style="color: var(--text-secondary); font-size: 12px; margin: 0;">
                                ğŸ’¡ <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø³ÙŠØ·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                            </p>
                            <p style="color: var(--text-secondary); font-size: 12px; margin: 8px 0 0 0;">
                                ğŸ“ Ù„Ø§ ØªÙ†Ø³Ù Ù…Ø´Ø§Ø±ÙƒØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø­ØµØ©)
                            </p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary-color);" id="joinLinkViews">
                            <div class="loader" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø©
                        </div>
                    </div>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--success-color);" id="joinLinkRegistrations">
                            <div class="loader" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            âœ… Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„
                        </div>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #3b82f6;" id="actualStudentCount">
                            <div class="loader" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            ğŸ“Š ÙØ¹Ù„ÙŠØ§Ù‹ ÙÙŠ DB
                        </div>
                    </div>
                </div>
                
                <!-- Refresh Button -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button 
                        class="btn" 
                        style="background: var(--secondary-color); color: white; padding: 8px 20px;"
                        onclick="refreshJoinLinkStats()"
                        title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
                        ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    </button>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button 
                        class="btn" 
                        style="flex: 1; background: #25D366; color: white;"
                        onclick="shareJoinLinkViaWhatsApp()"
                        title="Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                        ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    <button 
                        class="btn" 
                        style="flex: 1; background: #0088cc; color: white;"
                        onclick="shareJoinLinkViaTelegram()"
                        title="Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…">
                        âœˆï¸ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                    </button>
                    <button 
                        class="btn" 
                        style="flex: 1; background: var(--secondary-color); color: white;"
                        onclick="shareJoinLinkGeneric()"
                        title="Ù…Ø´Ø§Ø±ÙƒØ©">
                        ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeJoinLinkModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        // Join Link Modal Functions
        let currentJoinLink = null;

        async function openJoinLinkModal() {
            const modal = document.getElementById('joinLinkModal');
            const input = document.getElementById('joinLinkInput');
            const viewsEl = document.getElementById('joinLinkViews');
            const regsEl = document.getElementById('joinLinkRegistrations');

            // Show modal
            modal.style.display = 'flex';

            // Show loading
            viewsEl.innerHTML = '<div class="loader" style="width: 30px; height: 30px; margin: 0 auto;"></div>';
            regsEl.innerHTML = '<div class="loader" style="width: 30px; height: 30px; margin: 0 auto;"></div>';

            try {
                // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ token Ù…Ù† localStorage (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© sectionsAPI)
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                console.log('ğŸ” Token found, calling API...');
                
                // ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ body Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ Ù…ÙØ¹Ù‘Ù„Ø©
                const body = {};
                const enablePassword = document.getElementById('enablePassword');
                const linkPassword = document.getElementById('linkPassword');
                
                if (enablePassword.checked && linkPassword.value.trim()) {
                    body.password = linkPassword.value.trim();
                    console.log('ğŸ” Password enabled for join link');
                }
                
                const response = await fetch('http://localhost:8000/api/sections/teacher/join-link/generate/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                console.log('ğŸ“¡ API Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('âŒ API Error:', errorData);
                    throw new Error(errorData.error || errorData.detail || 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·');
                }

                const data = await response.json();
                console.log('âœ… API Data:', data);

                if (!data.success) {
                    throw new Error(data.error || 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·');
                }

                // Store link
                currentJoinLink = data.full_url;

                // Display link
                input.value = data.full_url;

                // Display stats
                viewsEl.textContent = data.stats.views;
                regsEl.textContent = data.stats.registrations;
                
                // ğŸ” Update password status
                updatePasswordStatus(data.has_password);
                
                // ğŸ“Š Load actual student count
                await loadActualStudentCount();
                
                console.log('âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¬Ø§Ù‡Ø²:', data.full_url);

            } catch (error) {
                console.error('âŒ Error in openJoinLinkModal:', error);
                UI.showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ' + error.message, 'error');
                closeJoinLinkModal();
            }
        }
        
        // ğŸ” Update password status display
        function updatePasswordStatus(hasPassword) {
            const statusEl = document.getElementById('passwordStatus');
            const enablePassword = document.getElementById('enablePassword');
            
            if (hasPassword) {
                statusEl.textContent = 'ğŸ”’ Ù…Ø­Ù…ÙŠ';
                statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                statusEl.style.color = 'var(--success-color)';
                enablePassword.checked = true;
                document.getElementById('passwordInputGroup').style.display = 'block';
            } else {
                statusEl.textContent = 'ØºÙŠØ± Ù…Ø­Ù…ÙŠ';
                statusEl.style.background = 'rgba(108, 117, 125, 0.2)';
                statusEl.style.color = 'var(--text-secondary)';
            }
        }

        function closeJoinLinkModal() {
            document.getElementById('joinLinkModal').style.display = 'none';
            currentJoinLink = null;
            
            // Reset password fields
            document.getElementById('enablePassword').checked = false;
            document.getElementById('linkPassword').value = '';
            document.getElementById('passwordInputGroup').style.display = 'none';
        }
        
        // ğŸ” Update join link password
        async function updateJoinLinkPassword() {
            try {
                const enablePassword = document.getElementById('enablePassword');
                const linkPassword = document.getElementById('linkPassword');
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                // Validate password if enabled
                if (enablePassword.checked && !linkPassword.value.trim()) {
                    UI.showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±', 'warning');
                    linkPassword.focus();
                    return;
                }
                
                // Prepare body
                const body = {};
                if (enablePassword.checked) {
                    body.password = linkPassword.value.trim();
                } else {
                    body.password = null; // Remove password
                }
                
                console.log('ğŸ” Updating join link password...');
                
                const response = await fetch('http://localhost:8000/api/sections/teacher/join-link/generate/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                }
                
                // Update UI
                updatePasswordStatus(data.has_password);
                UI.showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                console.log('âœ… Password updated, has_password:', data.has_password);
                
            } catch (error) {
                console.error('âŒ Error updating password:', error);
                UI.showToast('âŒ ' + error.message, 'error');
            }
        }
        
        // ğŸ“Š Load actual student count from database
        async function loadActualStudentCount() {
            const countEl = document.getElementById('actualStudentCount');
            
            try {
                const token = localStorage.getItem('access_token');
                if (!token) return;
                
                const response = await fetch('http://localhost:8000/api/sections/students/count/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    countEl.textContent = data.total || 0;
                    console.log('ğŸ“Š Actual student count:', data.total);
                } else {
                    countEl.textContent = '0';
                }
            } catch (error) {
                console.error('Error loading student count:', error);
                countEl.textContent = '0';
            }
        }
        
        // ğŸ”„ Refresh join link statistics
        async function refreshJoinLinkStats() {
            const viewsEl = document.getElementById('joinLinkViews');
            const regsEl = document.getElementById('joinLinkRegistrations');
            const countEl = document.getElementById('actualStudentCount');
            
            // Show loading
            viewsEl.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            regsEl.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            countEl.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                // Fetch join link stats
                const response = await fetch('http://localhost:8000/api/sections/teacher/join-link/generate/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    viewsEl.textContent = data.stats.views;
                    regsEl.textContent = data.stats.registrations;
                }
                
                // Fetch actual student count
                await loadActualStudentCount();
                
                UI.showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'success');
                
            } catch (error) {
                console.error('Error refreshing stats:', error);
                UI.showToast('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
                viewsEl.textContent = '0';
                regsEl.textContent = '0';
                countEl.textContent = '0';
            }
        }
        
        // ğŸ” Toggle password input
        document.addEventListener('DOMContentLoaded', () => {
            const enablePassword = document.getElementById('enablePassword');
            const passwordInputGroup = document.getElementById('passwordInputGroup');
            
            enablePassword?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    passwordInputGroup.style.display = 'block';
                    document.getElementById('linkPassword').focus();
                } else {
                    passwordInputGroup.style.display = 'none';
                    document.getElementById('linkPassword').value = '';
                }
            });
        });

        async function copyJoinLinkToClipboard() {
            const input = document.getElementById('joinLinkInput');
            
            try {
                await navigator.clipboard.writeText(input.value);
                UI.showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // Visual feedback
                input.select();
                setTimeout(() => {
                    window.getSelection().removeAllRanges();
                }, 300);
            } catch (error) {
                // Fallback
                input.select();
                document.execCommand('copy');
                UI.showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'success');
            }
        }

        function shareJoinLinkViaWhatsApp() {
            if (!currentJoinLink) return;
            
            const text = encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹\n\nØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:\n\n${currentJoinLink}\n\nØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù† Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ ğŸ“š`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareJoinLinkViaTelegram() {
            if (!currentJoinLink) return;
            
            const text = encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹\n\nØ±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„:\n${currentJoinLink}\n\nØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù† ğŸ“š`);
            window.open(`https://t.me/share/url?url=${encodeURIComponent(currentJoinLink)}&text=${text}`, '_blank');
        }

        async function shareJoinLinkGeneric() {
            if (!currentJoinLink) return;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - SmartEdu',
                        text: 'Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù† Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ',
                        url: currentJoinLink
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copyJoinLinkToClipboard();
                    }
                }
            } else {
                copyJoinLinkToClipboard();
            }
        }

        // Close modal on outside click
        document.getElementById('joinLinkModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeJoinLinkModal();
            }
        });
    </script>

    <!-- âœ… Dark Mode System -->
    <script src="/assets/js/dark-mode-manager.js"></script>
    <script src="/assets/js/dark-mode-init.js"></script>
</body>
</html>
