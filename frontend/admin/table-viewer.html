<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ - SmartEdu Admin</title>
    <link rel="stylesheet" href="/admin/css/admin-base.css">
    <style>
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            min-width: 100%;
            white-space: nowrap;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }

        .json-viewer {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow: auto;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>ğŸ“‹ <span id="tableName">Ø¬Ø¯ÙˆÙ„</span></h1>
            <div class="admin-user">
                <button class="btn btn-info btn-sm" onclick="window.location.href='/admin/dashboard.html'">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                <button class="btn btn-danger btn-sm" onclick="adminAuth.logout()">
                    ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <!-- Table Controls -->
        <div class="admin-card">
            <div class="table-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" class="form-control" 
                           placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...">
                </div>
                <div class="table-actions">
                    <button class="btn btn-success btn-sm" onclick="tableViewer.exportToCSV()">
                        ğŸ“¥ ØªØµØ¯ÙŠØ± CSV
                    </button>
                    <button class="btn btn-info btn-sm" onclick="tableViewer.exportToJSON()">
                        ğŸ“„ ØªØµØ¯ÙŠØ± JSON
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="tableViewer.refresh()">
                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>

            <!-- Table Info -->
            <div style="margin-bottom: 15px; color: var(--admin-text-light);">
                <span id="tableInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>

            <!-- Table Data -->
            <div class="table-wrapper">
                <div id="tableContainer">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="paginationContainer">
            </div>
        </div>
    </div>

    <!-- âœ… Config must load FIRST -->
    <script src="/assets/js/config.js"></script>
    <script src="/admin/js/admin-auth.js"></script>
    <script src="/admin/js/admin-api.js"></script>
    
    <script>
        class TableViewer {
            constructor() {
                this.tableName = '';
                this.data = null;
                this.filteredData = null;
                this.currentPage = 0;
                this.limit = 100;
            }

            async init() {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† URL
                const params = new URLSearchParams(window.location.search);
                this.tableName = params.get('table');

                if (!this.tableName) {
                    alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„');
                    window.location.href = '/admin/dashboard.html';
                    return;
                }

                // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                document.getElementById('tableName').textContent = this.tableName;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await this.loadData();

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterData(e.target.value);
                });
            }

            async loadData() {
                try {
                    this.data = await adminAPI.getTableData(this.tableName, this.limit, this.currentPage * this.limit);
                    this.filteredData = this.data.data;
                    this.render();
                } catch (error) {
                    this.showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                }
            }

            render() {
                if (!this.data || !this.filteredData) return;

                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
                document.getElementById('tableInfo').textContent = 
                    `Ø¹Ø±Ø¶ ${this.filteredData.length} Ù…Ù† Ø£ØµÙ„ ${this.data.total} Ø³Ø¬Ù„`;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const container = document.getElementById('tableContainer');
                
                if (this.filteredData.length === 0) {
                    container.innerHTML = '<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr>';
                
                // Headers
                this.data.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>';
                html += '</tr></thead><tbody>';

                // Rows
                this.filteredData.forEach(row => {
                    const rowId = row.id; // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ id
                    html += '<tr>';
                    this.data.columns.forEach(col => {
                        const value = row[col];
                        const displayValue = value === null ? '<em>null</em>' : 
                                           value === '' ? '<em>ÙØ§Ø±Øº</em>' : 
                                           String(value).substring(0, 100);
                        html += `<td>${displayValue}</td>`;
                    });
                    // Ø²Ø± Ø­Ø°Ù
                    html += `
                        <td>
                            <button class="btn btn-danger btn-sm" 
                                    onclick="tableViewer.deleteRow(${rowId})"
                                    title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </td>
                    `;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            filterData(searchTerm) {
                if (!searchTerm) {
                    this.filteredData = this.data.data;
                } else {
                    searchTerm = searchTerm.toLowerCase();
                    this.filteredData = this.data.data.filter(row => {
                        return Object.values(row).some(value => {
                            return String(value).toLowerCase().includes(searchTerm);
                        });
                    });
                }
                this.render();
            }

            async refresh() {
                await this.loadData();
            }

            exportToCSV() {
                if (!this.filteredData || this.filteredData.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }

                let csv = this.data.columns.join(',') + '\n';
                
                this.filteredData.forEach(row => {
                    const values = this.data.columns.map(col => {
                        const value = row[col];
                        return value === null ? '' : `"${String(value).replace(/"/g, '""')}"`;
                    });
                    csv += values.join(',') + '\n';
                });

                this.downloadFile(csv, `${this.tableName}.csv`, 'text/csv');
            }

            exportToJSON() {
                if (!this.filteredData || this.filteredData.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }

                const json = JSON.stringify(this.filteredData, null, 2);
                this.downloadFile(json, `${this.tableName}.json`, 'application/json');
            }

            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            async deleteRow(rowId) {
                if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø±Ù‚Ù… ${rowId}ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) {
                    return;
                }

                try {
                    await adminAPI.deleteRow(this.tableName, rowId);
                    
                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                    this.showSuccess(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø±Ù‚Ù… ${rowId} Ø¨Ù†Ø¬Ø§Ø­`);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    await this.refresh();
                } catch (error) {
                    this.showError('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„: ' + error.message);
                }
            }

            showSuccess(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = message;
                
                const container = document.querySelector('.admin-container');
                container.insertBefore(alertDiv, container.firstChild);
                
                setTimeout(() => alertDiv.remove(), 3000);
            }

            showError(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = message;
                
                const container = document.querySelector('.admin-container');
                container.insertBefore(alertDiv, container.firstChild);
                
                setTimeout(() => alertDiv.remove(), 5000);
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ instance Ø¹Ø§Ù…
        let tableViewer;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!adminAuth.requireAuth()) {
            // Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        } else {
            tableViewer = new TableViewer();
            tableViewer.init();
        }
    </script>
</body>
</html>
